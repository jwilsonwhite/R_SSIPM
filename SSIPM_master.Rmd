
---
title: "SSIPM_master"
author: "Will White"
date: '2023-01-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

# SSIPM Code for Nickols et al. SONGS artificial reefs project
# Author: Will White
# Based on code in White et al. 2016 Ecol Appl and subsequent modifications

# Base code will just estimate F and R for a single site...extensions/modifications as needed

```{r}
# load necessary libraries (including eventually the SSIPM library)
# library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(readr)
library(purrr)
library(tibble)
library(stringr)
library(forcats)
library(lubridate) 
library(bbmle) # library for maximum likelihood calculation
library(invgamma)#library for inverse gamma
# #library for parallel processing
# library(doParallel)

library(here)
source(here("SSIPM","calculate.prior.R"))
source(here("SSIPM","create.params.R"))
source(here("SSIPM","fit.SSIPM.MCMC.R"))
source(here("SSIPM","get.cand.R"))
source(here("SSIPM","kernmat.R"))
source(here("SSIPM","run.IPM.R"))
source(here("SSIPM","postproc.MCMC.R"))
source(here("SSIPM","ssipm.dic.R"))
```

```{r}
# Read in data
# This will work best if the data are arranged as abundance in each length bin on the rows, with a column for each annual observation. Missing years should be a column of NAs

{

{
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/668/4/60afbd5190f50ba5271dacdf74e549f3"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")


 dt1 <-read.csv(infile1,header=F
          ,skip=1
            ,sep=","
        , col.names=c(
                    "year",
                    "date",
                    "reef_code",
                    "polygon",
                    "phase_built_code",
                    "transect_code",
                    "visibility",
                    "species_code",
                    "genus_name",
                    "species_name",
                    "count",
                    "total_length",
                    "total_area_sampled"    ), check.names=TRUE)

unlink(infile1)

# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings

if (class(dt1$date)!="factor") dt1$date<- as.factor(dt1$date)
if (class(dt1$reef_code)!="factor") dt1$reef_code<- as.factor(dt1$reef_code)
if (class(dt1$polygon)!="factor") dt1$polygon<- as.factor(dt1$polygon)
if (class(dt1$phase_built_code)!="factor") dt1$phase_built_code<- as.factor(dt1$phase_built_code)
if (class(dt1$transect_code)!="factor") dt1$transect_code<- as.factor(dt1$transect_code)
if (class(dt1$visibility)=="factor") dt1$visibility <-as.numeric(levels(dt1$visibility))[as.integer(dt1$visibility) ]
if (class(dt1$visibility)=="character") dt1$visibility <-as.numeric(dt1$visibility)
if (class(dt1$species_code)!="factor") dt1$species_code<- as.factor(dt1$species_code)
if (class(dt1$genus_name)!="factor") dt1$genus_name<- as.factor(dt1$genus_name)
if (class(dt1$species_name)!="factor") dt1$species_name<- as.factor(dt1$species_name)
if (class(dt1$count)=="factor") dt1$count <-as.numeric(levels(dt1$count))[as.integer(dt1$count) ]
if (class(dt1$count)=="character") dt1$count <-as.numeric(dt1$count)
if (class(dt1$total_length)=="factor") dt1$total_length <-as.numeric(levels(dt1$total_length))[as.integer(dt1$total_length) ]
if (class(dt1$total_length)=="character") dt1$total_length <-as.numeric(dt1$total_length)
if (class(dt1$total_area_sampled)=="factor") dt1$total_area_sampled <-as.numeric(levels(dt1$total_area_sampled))[as.integer(dt1$total_area_sampled) ]
if (class(dt1$total_area_sampled)=="character") dt1$total_area_sampled <-as.numeric(dt1$total_area_sampled)

# Convert Missing Values to NA for non-dates

dt1$date <- as.factor(ifelse((trimws(as.character(dt1$date))==trimws("-99999")),NA,as.character(dt1$date)))
dt1$reef_code <- as.factor(ifelse((trimws(as.character(dt1$reef_code))==trimws("-99999")),NA,as.character(dt1$reef_code)))
dt1$polygon <- as.factor(ifelse((trimws(as.character(dt1$polygon))==trimws("-99999")),NA,as.character(dt1$polygon)))
dt1$phase_built_code <- as.factor(ifelse((trimws(as.character(dt1$phase_built_code))==trimws("-99999")),NA,as.character(dt1$phase_built_code)))
dt1$transect_code <- as.factor(ifelse((trimws(as.character(dt1$transect_code))==trimws("-99999")),NA,as.character(dt1$transect_code)))
dt1$visibility <- ifelse((trimws(as.character(dt1$visibility))==trimws("-99999")),NA,dt1$visibility)
suppressWarnings(dt1$visibility <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$visibility))==as.character(as.numeric("-99999"))),NA,dt1$visibility))
dt1$species_code <- as.factor(ifelse((trimws(as.character(dt1$species_code))==trimws("-99999")),NA,as.character(dt1$species_code)))
dt1$genus_name <- as.factor(ifelse((trimws(as.character(dt1$genus_name))==trimws("-99999")),NA,as.character(dt1$genus_name)))
dt1$species_name <- as.factor(ifelse((trimws(as.character(dt1$species_name))==trimws("-99999")),NA,as.character(dt1$species_name)))
dt1$count <- ifelse((trimws(as.character(dt1$count))==trimws("-99999")),NA,dt1$count)
suppressWarnings(dt1$count <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$count))==as.character(as.numeric("-99999"))),NA,dt1$count))
dt1$total_length <- ifelse((trimws(as.character(dt1$total_length))==trimws("-99999")),NA,dt1$total_length)
suppressWarnings(dt1$total_length <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_length))==as.character(as.numeric("-99999"))),NA,dt1$total_length))
dt1$total_area_sampled <- ifelse((trimws(as.character(dt1$total_area_sampled))==trimws("-99999")),NA,dt1$total_area_sampled)
suppressWarnings(dt1$total_area_sampled <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_area_sampled))==as.character(as.numeric("-99999"))),NA,dt1$total_area_sampled))


# Here is the structure of the input data frame:
str(dt1)
attach(dt1)
# The analyses below are basic descriptions of the variables. After testing, they should be replaced.

summary(year)
summary(date)
summary(reef_code)
summary(polygon)
summary(phase_built_code)
summary(transect_code)
summary(visibility)
summary(species_code)
summary(genus_name)
summary(species_name)
summary(count)
summary(total_length)
summary(total_area_sampled)
                # Get more details on character variables

summary(as.factor(dt1$date))
summary(as.factor(dt1$reef_code))
summary(as.factor(dt1$polygon))
summary(as.factor(dt1$phase_built_code))
summary(as.factor(dt1$transect_code))
summary(as.factor(dt1$species_code))
summary(as.factor(dt1$genus_name))
summary(as.factor(dt1$species_name))
detach(dt1)


  phase2_3 <- dt1 %>%
    filter(species_code %in% c("PACL", "OXCA", "PANE",
                               "CHPU", "EMJA", "SEPU")) %>%
    filter(case_when(year == 2009 ~ total_area_sampled == 100, T~ total_area_sampled %in% c(150,123)))
} #phase 2 & 3 data from public repository
{
  
  condpath <- here("data","songs") 
  files <- dir(path = condpath,
               pattern = ".csv",
               full.names = TRUE)
  songs_1 <- files %>% #iterating over files
    set_names(nm = files) %>% # set the id for everything in "files"
    map_df(read_csv, .id = "filename") %>% 
    mutate(polygon = as.factor(polygon), date_survey = ymd(date)) %>% 
    # filter(total_area_sampled >60) %>% 
    mutate(month = month(date_survey)) %>% 
    filter(month != 2) %>% 
    dplyr::select(-c(month,date_survey))
  } #add phase 1 data from data folder

  years <- data.frame(year = c(2000:2022))
  # songs <- songs_1 %>% dplyr::select(3:18) ########!!!!!!!!!!! Temp. using Phase1 data only
  songs <- bind_rows(songs_1,phase2_3) %>%
    select(3:18)
  songs <- left_join(years, songs)
}

#get total count - values from Phase 1 reefs ONLY, Bottom transect
songstotal <- songs %>% 
  filter(phase_built_code == "E", 
         transtype_strata %in% c("BOTTOM",NA))%>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
  drop_na(total_length) %>% 
  pivot_wider(names_from = year,values_from = tot_count) %>% 
  drop_na() %>% 
  filter(reef_code == "WNR") #data from one site

#filter one species 
fishtotal <- songstotal[which(songstotal$species_code == "SEPU"),] 

#get maximum length of fish surveyed
# total_length <- data.frame("total_length" =  as.numeric(c(1:max(fishtotal$total_length))))

#arrange to have a row for every size bin (1cm increment)
fishtotal <- fishtotal %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:114))) %>%      # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>%    # add years not included to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)

#plot individuals recorded per year
fishtotal %>% pivot_longer(cols = "2000":"2022",
             names_to = "year",
             values_to = "count") %>% 
  summarize(count = sum(count), .by = c(year)) %>% 
  ggplot()+
  geom_col(aes(x = year, y = count))+
  geom_hline(yintercept = 100)
```

```{r}
#Define the number of transects and total area surveyed
transect <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA),
         phase_built_code == "E") %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")
  # select(c(1:9))
transect <- as.matrix(transect)
```

```{r}
#Define the phase of AR construction and year (to eventually identify years of AR expansion & fishing regulation)
years <- colnames(fishtotal)
datyr <- c(1:dim(fishtotal)[2])
# phase <- c(1,rep("2",6), rep("2",dim(fishtotal)[2]-7))
phase <- c(1:23)
ar.phase <- cbind(years, datyr,phase)

```

```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'SEPU'
meshsize = 100
MCMClen = 100 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param$correction <- transect #add survey correction to fix.params
fix.param$phase <- phase
fix.param$error <- 0.05
```

```{r}
#set up immigration size distribution based on survey data
# im.smk <- songs %>%
#   filter( species_code == "SEPU",
#           reef_code %in% c("SMK"),
#          transtype_strata %in% c("BOTTOM",NA)) %>%
#   summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
#   drop_na(total_length) %>%
#   pivot_wider(names_from = year,values_from = tot_count) %>%
#   drop_na() %>%
#   full_join(.,data.frame(species_code = "SEPU", total_length = c(1:fix.param$meshmax))) %>% #get all lengths,for the length of meshsize
#   filter(total_length!=0) %>% #remove 0 length
#   arrange(total_length) %>%  # re-order dataframe by numerical value
#   dplyr::select(3:length(fishtotal)) %>% # choose only count of fish
#   replace(is.na(.),0) %>%  # NAs from added fish size = 0
#   select('2000') #!!!!! Try with one year
# 
# tot.bk <- data.frame( length = rownames(im.bk), count = im.bk$sum) %>%
#   uncount(count) %>% mutate(length = as.numeric(length)) # get overall value
# 
# bk.den <- density(tot.bk$length) #density at the last year
# af <- approxfun(bk.den$x,bk.den$y) #linear approximation of the values from density plot values
# temp <- c(fix.param$x) #length interval
# a <- af(temp) # approximate density based on
# a[ is.na(a)  ] = 1e-323
# a[c(1:fix.param$Ifish)] <- 0 #assume yoy sized fish are not migrants
# fix.param$Ivec <- a/sum(a*fix.param$dx) #add to fix.param
```

```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.0025) # recruitment
r.sd <- 0.1
i.mean <- log(0.02) #immigration
i.sd <- 0.1
F.mean <- log(0.25) # fishing
F.sd <- 0.1
error.mean = 2 # process error shape
error.sd = 0.025 # process error scale

Names <- c(paste0("r",c(1:(dim(fishtotal)[2]))), paste0("i",c(1:(dim(fishtotal)[2]))), 'F')

Means <- c(rep(r.mean,dim(fishtotal)[2]), rep(i.mean,dim(fishtotal)[2]), F.mean)

SDs <- c(rep(r.sd,dim(fishtotal)[2]), rep(i.sd,dim(fishtotal)[2]), F.sd)

Type <- c( c(rep("lognormal",dim(fishtotal)[2]),rep("lognormal",dim(fishtotal)[2]), "lognormal")) #type for recruitment, immigration, fishing, and process error

Prior <- list(Names,Means,SDs,Type)
names(Prior) <- c('Names','Means','SDs','Type')
```


```{r}
# Setup things for fitting via MCMC
Fit <- fit.SSIPM.MCMC(fix.param,fishtotal,Prior,'mc_str_ar_P_A.RData', burnin = FALSE)
# save the results...

```

```{r}
# #post-processing the chains (work in progress)
Post.fit<- postproc.MCMC(Fit) # combine chains & do diagnostic checks
 
```
 
```{r}
# Examine the prior historgram and trace plot
# par(mfrow = c(6,4))
hist(Post.fit$Values[,"r2"])
abline( v = median(Post.fit$Values[,"F"]), col = "red",lwd = 3)
text(x= 0.22, y = 18000, paste0("Median = ", round(median(Post.fit$Values[,"F"]), digits = 5)))

# plot(Post.fit$Values[,"r23"])
```
```{r}
# plot posterior values
ggplot()+
  geom_line(data = data.frame(Post.fit), aes(y = PosteriorProb, x = c(1:length(Post.fit$PosteriorProb))), color = "red")+
  # geom_vline(xintercept = c(75000,150000), linetype = "dashed")+
  xlim(0, length(Post.fit$PosteriorProb))+
  ylim(min(Post.fit$PosteriorProb),max(Post.fit$PosteriorProb))

plot(Post.fit$PosteriorProb)

# plot of posteriors
test <- data.frame(Post.fit$Values) %>%
  pivot_longer(cols = 1:47,
                names_to = "var",
                values_to = "posterior") %>%
  mutate(var = as.factor(var)) %>%
  mutate(var = fct_relevel(var, c(paste0("r",c(1:(dim(fishtotal)[2]))), paste0("i",c(1:(dim(fishtotal)[2]))), 'F')))
p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot()+
  geom_violin(aes( y = posterior, x = year , color = variable, fill = variable), alpha = 0.5)+
  facet_grid(rows = vars(variable), scales = "free_y")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    geom_vline(xintercept = c(8.5,20.5), color = "red")+
    theme_bw()
  # ggtitle("complex model")

p + annotate("rect", xmin = 14.5,xmax = 17.5,ymin = -Inf, ymax = Inf, fill = "red", alpha = 0.2) #add box around blob


```

```{r}
# DIC model selection
ssipm.dic(Data = fishtotal, fix.param = fix.param, postproc.MCMC = Post.fit)

```


```{r}
# #Posterior predictive checks (still in progress)
```


## Plots
#### TEST size distribution
```{r}
# recruit <- songstotal %>%
#   filter(species_code == "SEPU") %>%
#   mutate("length_class" = case_when(
#     total_length<9 ~ "yoy",
#                               total_length>=9&total_length<37~ "juvenile",
#                               total_length>=37~"adult")) %>%
#   mutate(length_class = factor(.$length_class, levels = c("yoy","juvenile","adult"))) %>%
#   pivot_longer(cols = c('2000':'2022'),
#               values_to = "count",
#               names_to = "year") %>%
#   summarise(count = sum(count), .by = c(reef_code, species_code, year,length_class)) %>%
#   left_join(., data.frame(transect) %>% pivot_longer(cols = c(1:23),names_to = "year", values_to = "transect_area") %>% mutate(year = as.character(c(2000:2022)))) %>%
#   mutate(average = count/transect_area) %>%
# mutate(probden = average * case_when( length_class == "juvenile" ~ sum(fix.param$x>=9&fix.param$x<37),
#                                       length_class == "adult" ~ sum(fix.param$x>=37),
#                                       TRUE~9))
# ggplot(data = recruit, aes(x = length_class, y = average))+
#   geom_col()+
#   facet_wrap(~year)


#####------------- Immigration size distribution
# 
# Names <- c(paste0("r",c(1:(dim(fishtotal)[2]))),"Im1", "Im2", 'F')
# 
# Means <- c(rep(exp(R.mean),dim(fishtotal)[2]), 0.03, 0.01, 0.25)
# 
# SDs <- c(rep(R.sd,dim(fishtotal)[2]), Im.sd,Im.sd, F.sd,1)
# Type <- c(rep('lognormal',dim(fishtotal)[2]), 'lognormal','lognormal',
#           "lognormal") #type for recruitment, immigration, fishing, and process error
# 
# Prior <- list(Names,Means,SDs,Type)
# names(Prior) <- c('Names','Means','SDs','Type')
# 
# 
# c(fix.param,Prior)
#   M = fix.param$MCMClen
#   Chains = fix.param$MCMCchains
# 
# ######-------Immigration ipm--------########
# Names <- c(paste0("r",c(1:(dim(fishtotal)[2]))),"i1", "i2", 'F')
#   Values <- matrix(NA,nrow=M,ncol =length(Names))
#   Values[1,] <- Prior$Means
#   colnames(Values) <- Names
#   cand.param <- Values[1,]
#    im.cand.param <-  c( rep(1,51), 0, cand.param["F"],0) #use updated cand.param F value
#     names(im.cand.param) <- c(paste0("r",c(0:50)), "Im",'F','error')
#     im.data <- fishtotal
#     im.data[,c(1:50)] <- NA #not reliant on data
#     im.ipm <- run.IPM(fix.param, im.cand.param, im.data, burnin = FALSE, burnin.im = FALSE, ipm.im = FALSE)
#     stbstate <- im.ipm$N[,50] # Distant future based on IPM
#     stbstate[c(1:fix.param$Ifish)] <- 0 #exclude nonimmigrant sizes
# 
#     #replace Ivec with new stable state distribution
#     fix.param$Ivec <- stbstate/sum(stbstate*fix.param$dx)
# ######-------Immigration wnr initial year--------########
# # total_length <-data.frame(total_length =  c(1:nrow(fishtotal)))
# # im.wnr.init <- songs %>%
# #   filter( species_code == "SEPU",
# #       year == 2000,
# #          transtype_strata %in% c("BOTTOM",NA)) %>%
# #   summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
# #   drop_na(total_length) %>%
# #   pivot_wider(names_from = year,values_from = tot_count) %>%
# #   drop_na() %>%
# #   filter(reef_code == "WNR") %>%  #data from one site
# #   full_join(.,total_length) %>%
# #   filter(total_length %in% c(1:max(total_length))) %>%
# #   arrange(total_length) %>%  # re-order dataframe by numerical value
# #   select(4) %>% # choose only count of fish
# #   replace(is.na(.),0) %>% #add NA
# #     # select("2000") %>%
# #   mutate(sum = rowSums( across(where(is.numeric))))  # sum across the row
# # 
# # tot.im.wnr.init <- data.frame( length = rownames(im.wnr.init), count = im.wnr.init$sum) %>%
# #   uncount(count) %>% mutate(length = as.numeric(length)) # get overall value
# # 
# # wnr.init.den <- density(tot.im.wnr.init$length)
# # af <- approxfun(wnr.init.den$x,wnr.init.den$y) #linear approximation of the values from density plot values
# # temp <- c(fix.param$x) #length interval
# # a <- af(temp) # approximate density based on
# # a[ is.na(a)  ] = 1e-323
# # a[c(1:fix.param$Ifish)] <- 0 #recruits are not moving
# # fix.param$Ivec <- a/sum(a*fix.param$dx)
# # plot(cbind(temp,a))
# ######-------Immigration bk culmative size dist--------########
# #
# #       im.bk <- songs %>%
# #   filter( species_code == "SEPU",
# #           reef_code %in% c("BK"),
# #          transtype_strata %in% c("BOTTOM",NA)) %>%
# #   summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%
# #   drop_na(total_length) %>%
# #   pivot_wider(names_from = year,values_from = tot_count) %>%
# #   drop_na() %>%
# #   # filter(reef_code%in% c("BK","SMK")) %>%  #data from one site
# #   full_join(.,total_length) %>%
# #   filter(total_length %in% c(1:max(total_length))) %>%
# #   arrange(total_length) %>%  # re-order dataframe by numerical value
# #   select(4:length(fishtotal)) %>% # choose only count of fish
# #   replace(is.na(.),0) %>% #add NA
# #     # select("2000") %>%
# #   mutate(sum = rowSums( across(where(is.numeric))))  # sum across the row
# #
# # tot.bk <- data.frame( length = rownames(im.bk), count = im.bk$sum) %>%
# #   uncount(count) %>% mutate(length = as.numeric(length)) # get overall value
# #
# # bk.den <- density(tot.bk$length)
# # af <- approxfun(bk.den$x,bk.den$y) #linear approximation of the values from density plot values
# # temp <- c(fix.param$x) #length interval
# # a <- af(temp) # approximate density based on
# # a[ is.na(a)  ] = 1e-323
# # a[c(1:fix.param$Ifish)] <- 0
# # fix.param$Ivec <- a/sum(a*fix.param$dx)
# # #
# # plot(cbind(temp,a))
# # a <- ggplot_build( ggplot(tot.bk)+
# #   geom_density(aes(x = length), bw = fix.param$dx))
# # b <- data.frame(a$data) %>% select(x,y)
# 
# ######-------Immigration--------########
# 
# 
# Values <- data.frame(matrix(NA,nrow=1,ncol =length(Prior$Names)))
# Values[1,] <- Prior$Means
# colnames(Values) <- Names
# test <- run.IPM(fix.param = fix.param, cand.param =  Values, fishtotal, burnin = FALSE)
# sizedist <- data.frame(test$N)
# 
# test.df <-  fishtotal
# test.df[,c(1:23)] <- NA
# test.na <- run.IPM(fix.param = fix.param, cand.param =  Values, test.df, burnin = FALSE)
# sizedist.na <- data.frame(test.na$N)
# 
# #
# #
# y = as.character(c(2000:2022))
# t.sect <- data.frame( t(transect)) %>%
#   mutate(year = as.character(rownames(.)))
# # #### Plot the distributions
# tfish <- fishtotal %>% add_column(size = c(1:nrow(fishtotal)), .before = '2000') %>%
#   pivot_longer(cols = c("2000":"2022"),
#                                     names_to = "year",
#                                     values_to = "count") %>%
#   left_join(., t.sect) %>%
#   mutate(density = count/t.transect.)
# 
# tipm <- sizedist %>% select(c(1:23)) %>% #IPM with data fitting
#   rename_all(~y) %>%  #rename columns to match year
#   add_column(size = c(1:nrow(sizedist)), .before = '2000') %>% #add sizes
#   mutate(size = size*fix.param$dx) %>%
#   pivot_longer(cols = "2000":"2022",
#                names_to = "year",
#                values_to = "N") %>%
#   group_by(year)
#   # mutate( tot_N = sum(N),
#   #   standardize = sum(N*fix.param$dx),
#   #   density= N/sum(N*fix.param$dx))
# 
# test.ivec <- tibble (fix.param$Ivec) %>% rename( "density" = 'fix.param$Ivec') %>% add_column(size = c(1:nrow(sizedist)))
# 
# # tfish <- fishtotal %>% add_column(size = c(1:nrow(fishtotal))) %>% 
# # pivot_longer(cols = 1:23, names_to = "year", values_to = "count") %>% mutate(num_density = count/transect)
# 
# ggplot()+
#   # geom_line(data = tipm, aes(x = size, y = N), color = "red")+
#   geom_line(test.ivec, mapping = aes(x = size, y = density),color = "blue")+ #immigration size distribution
#   # geom_bar(data = tfish, aes(x = size))+
#   geom_line(data = tfish, aes(x = size, y = density, color = "Survey density"), linewidth = 0.1) +
#     # geom_line(data = tipm.na, aes(x = size, y = N), color = "red")+
#   # geom_density(test, mapping = aes( x = total_length, group = reef_code), color = "purple")+
#   facet_wrap(~year, scales = "free_y") +
#   scale_y_continuous("survey density") +
#   # geom_vline(xintercept = 9, linetype = "dashed")+
#                      # sec.axis = sec_axis(~.,"ipm density"))+
#   # labs(color = "Density source")+
#     # scale_color_manual(values = c("Post.fit$Values[74900,]" = "red","Post.fit$Values[149800,]" ="blue","Post.fit$Values[225000,]" = "orange", "Survey density" = "black"))+
#     theme_bw()+
#   # theme(legend.position = c(.8,.07))+
#   # ggtitle("Example wiht Im2 = 0")+
#   # theme(axis.title.y.right = element_text( color = "red"),
#   #       axis.text.y.right = element_text(color = "red"))+
#   lims(x = c(0,70))
# # 
# # # 
# # Post.fit$Values[74900,]
# # Post.fit$Values[149800,]
# # Post.fit$Values[225000,]
# 
# ######--------- compare ipm im size distr to data
# total_length <-data.frame(total_length =  c(1:nrow(fishtotal)))
# reef <- data.frame(reef_code= c("WNR","BK","SMK"))
# lengthxreef <- cross_join(total_length,reef)
# 
# im.data <- songs %>%
#   filter( species_code == "SEPU",
#           reef_code %in% c("BK","SMK"),
#          transtype_strata %in% c("BOTTOM",NA)) %>%
#   summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>% 
#   drop_na(total_length) %>% 
#   pivot_wider(names_from = year, values_from = tot_count) %>% 
#   full_join(.,lengthxreef) %>% 
#   mutate(species_code = "SEPU") %>% 
#   replace(is.na(.),0) %>% 
#   pivot_longer(cols = c('2000':'2022'),
#                names_to = "year",values_to = "count") %>% 
#   uncount(count)
# 
# ggplot()+
#   geom_line(test.ivec, mapping = aes(x = size, y = density),color = "black")+
#   geom_density(im.data, mapping = aes(x = total_length,color = reef_code))+
#   facet_wrap(~year) +
#   lims(x = c(0,70))+theme_bw()
```
 
 