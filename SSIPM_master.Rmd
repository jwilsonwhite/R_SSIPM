
---
title: "SSIPM_master"
author: "Will White"
date: '2023-01-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

SSIPM Code for Nickols et al. SONGS artificial reefs project
Author: Will White
Based on code in White et al. 2016 Ecol Appl and subsequent modifications


```{r}
# load necessary libraries (including eventually the SSIPM library)
# library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(readr)
library(purrr)
library(tibble)
library(patchwork)
library(stringr)
library(forcats)
library(lubridate) 
library(bbmle) # library for maximum likelihood calculation
library(invgamma)#library for inverse gamma
# #library for parallel processing
# library(doParallel)

library(here)
source(here("SSIPM","calculate.prior.R"))
source(here("SSIPM","create.params.R"))
source(here("SSIPM","fit.SSIPM.MCMC.R"))
source(here("SSIPM","get.cand.R"))
source(here("SSIPM","kernmat.R"))
source(here("SSIPM","run.IPM.R"))
source(here("SSIPM","postproc.MCMC.R"))
source(here("SSIPM","ssipm.dic.R"))
source(here("SSIPM","post.pred.check.R"))
```

# Read in data
```{r}
# Read in data
# This will work best if the data are arranged as abundance in each length bin on the rows, with a column for each annual observation. Missing years should be a column of NAs

{

{
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/668/4/60afbd5190f50ba5271dacdf74e549f3"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")


 dt1 <-read.csv(infile1,header=F
          ,skip=1
            ,sep=","
        , col.names=c(
                    "year",
                    "date",
                    "reef_code",
                    "polygon",
                    "phase_built_code",
                    "transect_code",
                    "visibility",
                    "species_code",
                    "genus_name",
                    "species_name",
                    "count",
                    "total_length",
                    "total_area_sampled"    ), check.names=TRUE)

unlink(infile1)

# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings

if (class(dt1$date)!="factor") dt1$date<- as.factor(dt1$date)
if (class(dt1$reef_code)!="factor") dt1$reef_code<- as.factor(dt1$reef_code)
if (class(dt1$polygon)!="factor") dt1$polygon<- as.factor(dt1$polygon)
if (class(dt1$phase_built_code)!="factor") dt1$phase_built_code<- as.factor(dt1$phase_built_code)
if (class(dt1$transect_code)!="factor") dt1$transect_code<- as.factor(dt1$transect_code)
if (class(dt1$visibility)=="factor") dt1$visibility <-as.numeric(levels(dt1$visibility))[as.integer(dt1$visibility) ]
if (class(dt1$visibility)=="character") dt1$visibility <-as.numeric(dt1$visibility)
if (class(dt1$species_code)!="factor") dt1$species_code<- as.factor(dt1$species_code)
if (class(dt1$genus_name)!="factor") dt1$genus_name<- as.factor(dt1$genus_name)
if (class(dt1$species_name)!="factor") dt1$species_name<- as.factor(dt1$species_name)
if (class(dt1$count)=="factor") dt1$count <-as.numeric(levels(dt1$count))[as.integer(dt1$count) ]
if (class(dt1$count)=="character") dt1$count <-as.numeric(dt1$count)
if (class(dt1$total_length)=="factor") dt1$total_length <-as.numeric(levels(dt1$total_length))[as.integer(dt1$total_length) ]
if (class(dt1$total_length)=="character") dt1$total_length <-as.numeric(dt1$total_length)
if (class(dt1$total_area_sampled)=="factor") dt1$total_area_sampled <-as.numeric(levels(dt1$total_area_sampled))[as.integer(dt1$total_area_sampled) ]
if (class(dt1$total_area_sampled)=="character") dt1$total_area_sampled <-as.numeric(dt1$total_area_sampled)

# Convert Missing Values to NA for non-dates

dt1$date <- as.factor(ifelse((trimws(as.character(dt1$date))==trimws("-99999")),NA,as.character(dt1$date)))
dt1$reef_code <- as.factor(ifelse((trimws(as.character(dt1$reef_code))==trimws("-99999")),NA,as.character(dt1$reef_code)))
dt1$polygon <- as.factor(ifelse((trimws(as.character(dt1$polygon))==trimws("-99999")),NA,as.character(dt1$polygon)))
dt1$phase_built_code <- as.factor(ifelse((trimws(as.character(dt1$phase_built_code))==trimws("-99999")),NA,as.character(dt1$phase_built_code)))
dt1$transect_code <- as.factor(ifelse((trimws(as.character(dt1$transect_code))==trimws("-99999")),NA,as.character(dt1$transect_code)))
dt1$visibility <- ifelse((trimws(as.character(dt1$visibility))==trimws("-99999")),NA,dt1$visibility)
suppressWarnings(dt1$visibility <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$visibility))==as.character(as.numeric("-99999"))),NA,dt1$visibility))
dt1$species_code <- as.factor(ifelse((trimws(as.character(dt1$species_code))==trimws("-99999")),NA,as.character(dt1$species_code)))
dt1$genus_name <- as.factor(ifelse((trimws(as.character(dt1$genus_name))==trimws("-99999")),NA,as.character(dt1$genus_name)))
dt1$species_name <- as.factor(ifelse((trimws(as.character(dt1$species_name))==trimws("-99999")),NA,as.character(dt1$species_name)))
dt1$count <- ifelse((trimws(as.character(dt1$count))==trimws("-99999")),NA,dt1$count)
suppressWarnings(dt1$count <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$count))==as.character(as.numeric("-99999"))),NA,dt1$count))
dt1$total_length <- ifelse((trimws(as.character(dt1$total_length))==trimws("-99999")),NA,dt1$total_length)
suppressWarnings(dt1$total_length <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_length))==as.character(as.numeric("-99999"))),NA,dt1$total_length))
dt1$total_area_sampled <- ifelse((trimws(as.character(dt1$total_area_sampled))==trimws("-99999")),NA,dt1$total_area_sampled)
suppressWarnings(dt1$total_area_sampled <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_area_sampled))==as.character(as.numeric("-99999"))),NA,dt1$total_area_sampled))


# Here is the structure of the input data frame:
str(dt1)
attach(dt1)
# The analyses below are basic descriptions of the variables. After testing, they should be replaced.

summary(year)
summary(date)
summary(reef_code)
summary(polygon)
summary(phase_built_code)
summary(transect_code)
summary(visibility)
summary(species_code)
summary(genus_name)
summary(species_name)
summary(count)
summary(total_length)
summary(total_area_sampled)
                # Get more details on character variables

summary(as.factor(dt1$date))
summary(as.factor(dt1$reef_code))
summary(as.factor(dt1$polygon))
summary(as.factor(dt1$phase_built_code))
summary(as.factor(dt1$transect_code))
summary(as.factor(dt1$species_code))
summary(as.factor(dt1$genus_name))
summary(as.factor(dt1$species_name))
detach(dt1)


  phase2_3 <- dt1 %>%
    filter(species_code %in% c("PACL", "OXCA", "PANE",
                               "CHPU", "EMJA", "SEPU")) %>%
    filter(case_when(year == 2009 ~ total_area_sampled == 100, T~ total_area_sampled %in% c(150,123)))
} #phase 2 & 3 data from public repository
{
  
  condpath <- here("data","songs") 
  files <- dir(path = condpath,
               pattern = ".csv",
               full.names = TRUE)
  songs_1 <- files %>% #iterating over files
    set_names(nm = files) %>% # set the id for everything in "files"
    map_df(read_csv, .id = "filename") %>% 
    mutate(polygon = as.factor(polygon), date_survey = ymd(date)) %>% 
    # filter(total_area_sampled >60) %>% 
    mutate(month = month(date_survey)) %>% 
    filter(month != 2) %>% 
    dplyr::select(-c(month,date_survey))
  } #add phase 1 data from data folder

  years <- data.frame(year = c(2000:2022))
  # songs <- songs_1 %>% dplyr::select(3:18) ########!!!!!!!!!!! Temp. using Phase1 data only
  songs <- bind_rows(songs_1,phase2_3) %>%
    select(3:18)
  songs <- left_join(years, songs)
}
```

# Wrangle data

### Phase 1 - experiment Reefs
```{r}
#get total count - values from Phase 1 reefs ONLY, Bottom transect
songstotal <- songs %>% 
  filter(phase_built_code == "E", 
         transtype_strata %in% c("BOTTOM",NA))%>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
  drop_na(total_length) %>% 
  pivot_wider(names_from = year,values_from = tot_count) %>% 
  drop_na() %>% 
  filter(reef_code == "WNR") #data from one site

#filter one species 
fishtotal.sepu <- songstotal[which(songstotal$species_code == "SEPU"),] 
fishtotal.pacl <- songstotal[which(songstotal$species_code == "PACL"),] 
fishtotal.pane <- songstotal[which(songstotal$species_code == "PANE"),] 

```

### Arrange data
```{r}
#arrange to have a row for every size bin (1cm increment)

#California Sheephead
fishtotal.sepu <- fishtotal.sepu %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.sepu$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.sepu)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:114))) %>%      # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>%    # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)

# Kelp Bass
fishtotal.pacl <- fishtotal.pacl %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.pacl$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pacl)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:140))) %>%  # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>% # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)
  
# Barred Sandbass
fishtotal.pane <- fishtotal.pane %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.pane$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pane)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:122))) %>%  # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>%    # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)


#graph size histogram
# fishtotal %>% mutate("length" = c(1:nrow(.))) %>%
#   pivot_longer(cols = 1:23,
#                names_to = "year", values_to = "count") %>%
#   ggplot()+
#   geom_col(mapping = aes(x = length, y = count))+
#   geom_vline(xintercept = 8.5, color = "red", linewidth = 0.5)+
#   lims(x = c(0,70))+
#   facet_wrap(~year, scales = "free")+
#   ggtitle("WNR SEPU survey histogram")
```

### Phase 2 - Mitigation Reefs
```{r}
#get total count - values from Phase 2 reefs ONLY, Bottom transect
songstotal.mitigation <- songs %>% 
  filter(phase_built_code == "M", 
         transtype_strata %in% c("BOTTOM",NA))%>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
  drop_na(total_length) %>% 
  pivot_wider(names_from = year,values_from = tot_count) %>% 
  drop_na() %>% 
  filter(reef_code == "WNR") #data from one site

#filter one species 
fishtotal.m.sepu <- songstotal.mitigation[which(songstotal.mitigation$species_code == "SEPU"),] 

fishtotal.m.pacl <- songstotal.mitigation[which(songstotal.mitigation$species_code == "PACL"),] 

fishtotal.m.pane <- songstotal.mitigation[which(songstotal.mitigation$species_code == "PANE"),] 

```

### Arrange data
```{r}
#California Sheephead

#arrange to have a row for every size bin (1cm increment)
fishtotal.m.sepu <- fishtotal.m.sepu %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.sepu$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.sepu)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:114))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)

#Kelp Bass
fishtotal.m.pacl <- fishtotal.m.pacl %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.pacl$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.pacl)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:140))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)

#Barred Sandbass
fishtotal.m.pane <- fishtotal.m.pane %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.pane$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.pane)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:122))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)
```

# Transect area surveyed per year
```{r}
#Define the number of transects and total area surveyed

#phase 1 reef
transect <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA),
         phase_built_code == "E") %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")
transect <- as.matrix(transect)

# phase 2 reef
transect_mitigation <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA),
         phase_built_code == "M") %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area)
transect_mitigation <- as.matrix(transect_mitigation)
```

# Regulation list
```{r}
#Define the years of survey and corresponding regulation for Kelp Bass and Barred Sandbass, and check it matches with year of change
years <- colnames(fishtotal.sepu)
datyr <- c(1:dim(fishtotal.sepu)[2])
regulation <- c(rep("1",length(c(2000:2012))), rep("2",length(c(2013:2022))))

years <- colnames(fishtotal.m.sepu)
datyr <- c(1:dim(fishtotal.m.sepu)[2])
regulation.m <- c(rep("1",length(c(2009:2012))), rep("2",length(c(2013:2022))))


```

# Fixed Parameters

### California Sheephead
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'SEPU'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.sepu <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.sepu$correction <- transect #add survey correction to fix.params
fix.param.sepu$error <- 0.05 #fixed process error
fix.param.sepu$regulation <- NULL #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.sepu <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.sepu$correction <- transect_mitigation
fix.param.m.sepu$error <- 0.05 #fixed process error
fix.param.m.sepu$regulation <- NULL #No change in regulation occured

```

### Kelp Bass
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'PACL'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.pacl <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.pacl$correction <- transect #add survey correction to fix.params
fix.param.pacl$error <- 0.05 #fixed process error
fix.param.pacl$regulation <- regulation #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.pacl <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.pacl$correction <- transect_mitigation
fix.param.m.pacl$error <- 0.05 #fixed process error
fix.param.m.pacl$regulation <- regulation.m #Insert identifier for changes in regulation
```

### Barred Sandbass
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'PANE'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.pane <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.pane$correction <- transect #add survey correction to fix.params
fix.param.pane$error <- 0.05 #fixed process error
fix.param.pane$regulation <- regulation #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.pane <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.pane$correction <- transect_mitigation
fix.param.m.pane$error <- 0.05 #fixed process error
fix.param.m.pane$regulation <- regulation.m #Insert identifier for changes in regulation
```


# Immigration size distribution based on survey data from natural reef (SMK)

### California Sheephead
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "SEPU",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "SEPU", total_length = c(1:fix.param.sepu$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.sepu)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.sepu$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.sepu$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.sepu$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.sepu$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.25,0) #use fixed cand.param F value
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.ipm <- run.IPM(fix.param.sepu, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.sepu$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.sepu$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.sepu$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.sepu$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name

#visual of size distribution by year
# df.ivec %>% mutate("length" = c(1:nrow(.))) %>% 
#   pivot_longer(cols = 1:23,
#                names_to = "year", values_to = "sizedist") %>% 
#   ggplot()+
#   geom_line(aes(x = length, y = sizedist))+
#   facet_wrap(~year)+ggtitle("Size distribution (lag+1)")

#add to fix.param
fix.param.sepu <- c(fix.param.sepu,Ivec)

#add to fix.param.mitigation
Ivec.m.sepu <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.sepu) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.sepu)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.sepu <- c(fix.param.m.sepu,Ivec.m.sepu)
```

### Kelp Bass
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "PACL",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "PACL", total_length = c(1:fix.param.pacl$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pacl)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.pacl$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.pacl$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.pacl$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.pacl$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.12,0) #use fixed F value from literature
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.fix.param.pacl <- fix.param.pacl 
      i.fix.param.pacl$regulation <- rep(1,length(c(0:50))) #regulation match year of 
      i.ipm <- run.IPM(i.fix.param.pacl, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.pacl$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.pacl$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.pacl$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.pacl$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name

# visual of size distribution by year
# df.ivec %>% mutate("length" = c(1:nrow(.))) %>%
#   pivot_longer(cols = 1:23,
#                names_to = "year", values_to = "sizedist") %>%
#   ggplot()+
#   geom_line(aes(x = length, y = sizedist))+
#   facet_wrap(~year)+ggtitle("Size distribution (lag+1)")+
#   xlim(c(0,80))

#add to fix.param
fix.param.pacl <- c(fix.param.pacl,Ivec)

#add to fix.param.mitigation
Ivec.m.pacl <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.pacl) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.pacl)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.pacl <- c(fix.param.m.pacl,Ivec.m.pacl)
```

### Barred Sandbass
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "PANE",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "PANE", total_length = c(1:fix.param.pane$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pane)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.pane$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.pane$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.pane$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.pane$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.12,0) #use fixed F value from literature
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.fix.param.pane <- fix.param.pane 
      i.fix.param.pane$regulation <- rep(1,length(c(0:50))) #regulation match years of missing survey
      i.ipm <- run.IPM(i.fix.param.pane, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.pane$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.pane$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.pane$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.pane$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name

# visual of size distribution by year
# df.ivec %>% mutate("length" = c(1:nrow(.))) %>%
#   pivot_longer(cols = 1:23,
#                names_to = "year", values_to = "sizedist") %>%
#   ggplot()+
#   geom_line(aes(x = length, y = sizedist))+
#   facet_wrap(~year)+ggtitle("Size distribution (lag+1)")+
#   xlim(c(0,80))

#add to fix.param
fix.param.pane <- c(fix.param.pane,Ivec)

#add to fix.param.mitigation
Ivec.m.pane <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.pane) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.pane)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.pane <- c(fix.param.m.pane,Ivec.m.pane)
```


# Size-dependent immigration function
Size dependent immigration funciton is used to correct for smaller fishes less likely to immigrate from one reef to another

Survey mean size and standard deviation across all years

### California Sheephead
Small size likely to move if more large fish (Topping et al)
```{r}
I.size.param <- songs %>%
  filter( species_code == "SEPU",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>% 
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>% 
  # filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>% 
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

I.size.fun <- pnorm(q = fix.param.sepu$x, mean = I.size.param$mean, sd = I.size.param$sd) #culumutive distribution function

# add to fixed parameters
fix.param.sepu$I.size <- I.size.fun
fix.param.m.sepu$I.size <- I.size.fun

```

### Kelp Bass 
Smaller fish more likely to move, larger adult fish more stationary (Lowe et al 2003)
```{r}
I.size.param <- songs %>%
  filter( species_code == "PACL",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>%
  filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>%
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

I.size.fun <- 1-pnorm(q = fix.param.pacl$x, mean = I.size.param$mean, sd = I.size.param$sd) #cumulative distribution function

fix.param.pacl$I.size <- I.size.fun
fix.param.m.pacl$I.size <- I.size.fun

```

### Barred Sandbass 
larger fish have smaller home range (Mason & Lowe 2010)
```{r}
I.size.param <- songs %>%
  filter( species_code == "PANE",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>%
  # filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>%
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

I.size.fun <- (1-pnorm(q = fix.param.pane$x, mean = I.size.param$mean, sd = I.size.param$sd)*0.5)

fix.param.pane$I.size <- I.size.fun
fix.param.m.pane$I.size <- I.size.fun
```


# Priors

### California Sheephead
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.0025) # recruitment
r.sd <- 0.1
i.mean <- log(0.02) #immigration
i.sd <- 0.1
F.mean <- log(0.22) # fishing
F.sd <- 0.1
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.sepu)[2]))), paste0("i",c(1:(dim(fishtotal.sepu)[2]))), 'F', "nb.k")
Means <- c(rep(r.mean,dim(fishtotal.sepu)[2]), rep(i.mean,dim(fishtotal.sepu)[2]), F.mean,nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.sepu)[2]), rep(i.sd,dim(fishtotal.sepu)[2]), F.sd,nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.sepu)[2]),rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and  error
Prior.p.a.sepu <- list(Names,Means,SDs,Type)
names(Prior.p.a.sepu) <- c('Names','Means','SDs','Type')

# P
Names <- c(paste0("r",c(1:(dim(fishtotal.sepu)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.sepu)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.sepu)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and  error
Prior.p.sepu <- list(Names,Means,SDs,Type)
names(Prior.p.sepu) <- c('Names','Means','SDs','Type')

#A
Names <- c( paste0("i",c(1:(dim(fishtotal.sepu)[2]))), 'F','nb.k')
Means <- c( rep(i.mean,dim(fishtotal.sepu)[2]), F.mean, nb.k.mean)
SDs <- c(rep(i.sd,dim(fishtotal.sepu)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and  error
Prior.a.sepu <- list(Names,Means,SDs,Type)
names(Prior.a.sepu) <- c('Names','Means','SDs','Type')
```


```{r}
# phase 2 priors

# P & A 
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.sepu)[2]))), paste0("i",c(1:(dim(fishtotal.m.sepu)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.sepu)[2]), rep(i.mean,dim(fishtotal.m.sepu)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.sepu)[2]), rep(i.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.sepu)[2]),rep("lognormal",dim(fishtotal.m.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.sepu.m) <- c('Names','Means','SDs','Type')


# P  
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.sepu)[2]))),  'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.sepu)[2]),  F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.sepu)[2]),"lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.sepu.m) <- c('Names','Means','SDs','Type')

# A 
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.sepu)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(i.mean,dim(fishtotal.m.sepu)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.sepu)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.sepu.m) <- c('Names','Means','SDs','Type')
```


### Kelp Bass
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.0025) # recruitment
r.sd <- 0.1
i.mean <- log(0.01) #immigration
i.sd <- 0.1
F.mean <- log(0.12) # fishing
F.sd <- 0.1
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.pacl)[2]))), paste0("i",c(1:(dim(fishtotal.pacl)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pacl)[2]), rep(i.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pacl)[2]), rep(i.sd,dim(fishtotal.pacl)[2]), F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pacl)[2]),rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pacl <- list(Names,Means,SDs,Type)
names(Prior.p.a.pacl) <- c('Names','Means','SDs','Type')

# P 
Names <- c(paste0("r",c(1:(dim(fishtotal.pacl)[2]))),  'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pacl)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.pacl <- list(Names,Means,SDs,Type)
names(Prior.p.pacl) <- c('Names','Means','SDs','Type')

# A
Names <- c( paste0("i",c(1:(dim(fishtotal.pacl)[2]))), 'F','nb.k')
Means <- c( rep(i.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c( rep(i.sd,dim(fishtotal.pacl)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pacl <- list(Names,Means,SDs,Type)
names(Prior.a.pacl) <- c('Names','Means','SDs','Type')
```

```{r}
# phase 2 priors

# P & A
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pacl)[2]))), paste0("i",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pacl)[2]), rep(i.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pacl)[2]), rep(i.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.pacl)[2]),rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.pacl.m) <- c('Names','Means','SDs','Type')

# P
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.p.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.pacl.m) <- c('Names','Means','SDs','Type')

# A
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c( rep(i.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.pacl.m) <- c('Names','Means','SDs','Type')

```

### Barred Sandbass
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.001) # recruitment
r.sd <- 0.1
i.mean <- log(0.01) #immigration
i.sd <- 0.1
F.mean <- log(0.1) # fishing
F.sd <- 0.1
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.pane)[2]))), paste0("i",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pane)[2]), rep(i.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pane)[2]), rep(i.sd,dim(fishtotal.pane)[2]), F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pane)[2]),rep("lognormal",dim(fishtotal.pane)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pane <- list(Names,Means,SDs,Type)
names(Prior.p.a.pane) <- c('Names','Means','SDs','Type')

# P
Names <- c(paste0("r",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pane)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pane)[2]),"lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.pane <- list(Names,Means,SDs,Type)
names(Prior.p.pane) <- c('Names','Means','SDs','Type')

# A
Names <- c( paste0("i",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(i.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c( rep(i.sd,dim(fishtotal.pane)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pane <- list(Names,Means,SDs,Type)
names(Prior.a.pane) <- c('Names','Means','SDs','Type')
```

```{r}
# phase 2 priors

# P & A
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pane)[2]))), paste0("i",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pane)[2]), rep(i.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pane)[2]), rep(i.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.pane)[2]),rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.pane.m) <- c('Names','Means','SDs','Type')

# P
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.p.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.pane.m) <- c('Names','Means','SDs','Type')

# A
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c( rep(i.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.pane.m) <- c('Names','Means','SDs','Type')

```

#MCMC - Setup things for fitting via MCMC

### California Sheephead
```{r}
#California Sheephead

# Fit.p.a.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.p.a.sepu,'mc_str_ar_P_A_sepu.RData', burnin = FALSE)
# Fit.a.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.a.sepu,'mc_str_ar_A_sepu.RData', burnin = FALSE, ipm.r = FALSE)
# Fit.p.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.p.sepu,'mc_str_ar_P_sepu.RData', burnin = FALSE, ipm.i = FALSE)
# 
# Fit.p.a.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.p.a.sepu.m,'mc_str_ar_P_A_sepu_mitigation.RData', burnin = FALSE)
# Fit.p.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.p.sepu.m,'mc_str_ar_P_sepu_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# Fit.a.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.a.sepu.m,'mc_str_ar_A_sepu_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

### Kelp Bass
```{r}

# Fit.p.a.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.p.a.pacl,'mc_str_ar_P_A_pacl.RData', burnin = FALSE)
# Fit.p.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.p.pacl,'mc_str_ar_P_pacl.RData', burnin = FALSE,ipm.i = FALSE)
# Fit.a.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.a.pacl,'mc_str_ar_A_pacl.RData', burnin = FALSE,ipm.r = FALSE)
# #
# Fit.p.a.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.p.a.pacl.m,'mc_str_ar_P_A_pacl_mitigation.RData', burnin = FALSE)
# #
# Fit.p.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.p.pacl.m,'mc_str_ar_P_pacl_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# #
# Fit.a.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.a.pacl.m,'mc_str_ar_A_pacl_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

### Barred Sandbass
```{r}
# Fit.p.a.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.p.a.pane,'mc_str_ar_P_A_pane.RData', burnin = FALSE)
# Fit.p.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.p.pane,'mc_str_ar_P_pane.RData', burnin = FALSE,ipm.i = FALSE)
# Fit.a.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.a.pane,'mc_str_ar_A_pane.RData', burnin = FALSE,ipm.r = FALSE)
#
# Fit.p.a.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.p.a.pane.m,'mc_str_ar_P_A_pane_mitigation.RData', burnin = FALSE)
#
# Fit.p.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.p.pane.m,'mc_str_ar_P_pane_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# #
# Fit.a.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.a.pane,'mc_str_ar_A_pane_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

# Call Rdata from files

### California Sheepehad
```{r}
load(here("output", "mc_str_ar_P_A_sepu.RData"))
Fit.p.a.sepu <- mc_str

load(here("output", "mc_str_ar_P_sepu.RData"))
Fit.p.sepu <- mc_str

load(here("output", "mc_str_ar_A_sepu.RData"))
Fit.a.sepu <- mc_str

load(here("output", "mc_str_ar_P_A_sepu_mitigation.RData"))
Fit.p.a.sepu.m <- mc_str

load(here("output", "mc_str_ar_P_sepu_mitigation.RData"))
Fit.p.sepu.m <- mc_str

load(here("output", "mc_str_ar_A_sepu_mitigation.RData"))
Fit.a.sepu.m <- mc_str
```

### Kelp Bass
```{r}
load(here("output", "mc_str_ar_P_A_pacl.RData"))
Fit.p.a.pacl <- mc_str

load(here("output", "mc_str_ar_P_pacl.RData"))
Fit.p.pacl <- mc_str

load(here("output", "mc_str_ar_A_pacl.RData"))
Fit.a.pacl <- mc_str

load(here("output", "mc_str_ar_P_A_pacl_mitigation.RData"))
Fit.p.a.pacl.m <- mc_str

load(here("output", "mc_str_ar_P_pacl_mitigation.RData"))
Fit.p.pacl.m <- mc_str

load(here("output", "mc_str_ar_A_pacl_mitigation.RData"))
Fit.a.pacl.m <- mc_str
```

### Barred Sandbass
```{r}
load(here("output", "mc_str_ar_P_A_pane.RData"))
Fit.p.a.pane <- mc_str

load(here("output", "mc_str_ar_P_pane.RData"))
Fit.p.pane <- mc_str

load(here("output", "mc_str_ar_A_pane.RData"))
Fit.a.pane <- mc_str

load(here("output", "mc_str_ar_P_A_pane_mitigation.RData"))
Fit.p.a.pane.m <- mc_str

load(here("output", "mc_str_ar_P_pane_mitigation.RData"))
Fit.p.pane.m <- mc_str

load(here("output", "mc_str_ar_A_pane_mitigation.RData"))
Fit.a.pane.m <- mc_str
```


# Post-processing the chains 
combine chains & do diagnostic checks

### California Sheepehad
```{r}
Post.fit.p.a.sepu<- postproc.MCMC(Fit.p.a.sepu)
Post.fit.p.sepu<- postproc.MCMC(Fit.p.sepu)
Post.fit.a.sepu<- postproc.MCMC(Fit.a.sepu)
# 
Post.fit.p.a.mitigation <- postproc.MCMC(Fit.p.a.sepu.m)
Post.fit.p.mitigation <- postproc.MCMC(Fit.p.sepu.m)
Post.fit.a.mitigation <- postproc.MCMC(Fit.a.sepu.m)

```

### Kelp Bass
```{r}
Post.fit.p.a.pacl <- postproc.MCMC(Fit.p.a.pacl)
Post.fit.p.pacl<- postproc.MCMC(Fit.p.pacl)
Post.fit.a.pacl<- postproc.MCMC(Fit.a.pacl)

Post.fit.p.a.pacl.m <- postproc.MCMC(Fit.p.a.pacl.m)
Post.fit.p.pacl.m <- postproc.MCMC(Fit.p.pacl.m)
Post.fit.a.pacl.m <- postproc.MCMC(Fit.a.pacl.m)
```

### Barred Sandbass
```{r}
Post.fit.p.a.pane <- postproc.MCMC(Fit.p.a.pane)
Post.fit.p.pane<- postproc.MCMC(Fit.p.pane)
Post.fit.a.pane<- postproc.MCMC(Fit.a.pane)

Post.fit.p.a.pane.m <- postproc.MCMC(Fit.p.a.pane.m)
Post.fit.p.pane.m <- postproc.MCMC(Fit.p.pane.m)
Post.fit.a.pane.m <- postproc.MCMC(Fit.a.pane.m)
```

# DIC model selection

### California Sheepehad
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.sepu)$DIC #6096.505
ssipm.dic(postproc.MCMC = Post.fit.p.sepu)$DIC # 42091.53
ssipm.dic(postproc.MCMC = Post.fit.a.sepu)$DIC #11195

ssipm.dic(postproc.MCMC = Post.fit.p.a.mitigation)$DIC # 6004.068
ssipm.dic(postproc.MCMC = Post.fit.p.mitigation)$DIC # 11780.2
ssipm.dic(postproc.MCMC = Post.fit.a.mitigation)$DIC # 9236.886
```

### Kelp Bass
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.pacl)$DIC # 4159.849
ssipm.dic(postproc.MCMC = Post.fit.p.pacl)$DIC # 31011.92
ssipm.dic(postproc.MCMC = Post.fit.a.pacl)$DIC # 4595.92

ssipm.dic(postproc.MCMC = Post.fit.p.a.pacl.m)$DIC # 3504.267
ssipm.dic(postproc.MCMC = Post.fit.p.pacl.m)$DIC # 5107.235
ssipm.dic(postproc.MCMC = Post.fit.a.pacl.m)$DIC # 3641.209
```

### Barred Sandbass
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.pane)$DIC # 4330.184
ssipm.dic(postproc.MCMC = Post.fit.p.pane)$DIC # 35769.25
ssipm.dic(postproc.MCMC = Post.fit.a.pane)$DIC # 6263.839

ssipm.dic(postproc.MCMC = Post.fit.p.a.pane.m)$DIC # 3962.039
ssipm.dic(postproc.MCMC = Post.fit.p.pane.m)$DIC # 12151.83
ssipm.dic(postproc.MCMC = Post.fit.a.pane.m)$DIC # 4890.307
```


#Posterior predictive checks 
```{r}
#best California sheephead model
sepu <- post.pred.check(Data = fishtotal.sepu,fix.param = fix.param.sepu, Post.fit = Post.fit.p.a.sepu, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
sepu.m <- post.pred.check(Data = fishtotal.m.sepu,fix.param = fix.param.m.sepu, Post.fit = Post.fit.p.a.mitigation, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#best Kelp bass model
pacl <- post.pred.check(Data = fishtotal.pacl,fix.param = fix.param.pacl, Post.fit = Post.fit.p.a.pacl, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

pacl.m <- post.pred.check(Data = fishtotal.m.pacl, fix.param = fix.param.m.pacl, Post.fit = Post.fit.p.a.pacl.m, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))


#best Barred Sandbass model
pane <- post.pred.check(Data = fishtotal.pane,fix.param = fix.param.pane, Post.fit = Post.fit.p.a.pane, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))


pane.m <- post.pred.check(Data = fishtotal.m.pane,fix.param = fix.param.m.pane, Post.fit = Post.fit.p.a.pane.m, ipm.burnin = FALSE)
# ggsave("post.pred.p.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

```


# Plot results

Plot results and save to folder

Build functions to streamline plotmaking
```{r}
# Examine the prior historgram and trace plot
trace.plot <- function(post.fit,ggtitle){ggplot()+
  geom_line(data = data.frame(post.fit), aes(y = post.fit$PosteriorProb, x = c(1:length(post.fit$PosteriorProb))), color = "black")+
  xlim(0, length(post.fit$PosteriorProb))+
  ylim(min(post.fit$PosteriorProb),max(post.fit$PosteriorProb))+ggtitle(ggtitle)+
    theme(axis.title.x = element_blank())} #make trace plot using probability estimations

posterior.plot <- function(data,post.fit,model,ggtitle){
  test <- data.frame(post.fit$Values) %>%
  pivot_longer(cols = 1:(ncol(post.fit$Values)-2), # get only recruit and immigration variables
                names_to = "var",
                values_to = "posterior") %>%
  mutate(var = as.factor(var)) %>%
  mutate(var = fct_relevel(var, c(paste0("r",c(1:(dim(data)[2]))), paste0("i",c(1:(dim(data)[2]))), 'F', "nb.k")))
  
  if(model == "PA"){
p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  # filter(variable == "Immigrant") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior *10000, x = year , color = variable, fill = variable), alpha = 0.5)+ #transform from per m2 to hectare
  labs(y = "individals per hectare")+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  # scale_fill_manual(values = c( "#F8766D","#00BFC4"))+
  # scale_color_manual(values = c("#F8766D","#00BFC4"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10')+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 15),strip.text = element_text(size = 15),
          axis.title = element_text(size = 15))
  }
  if(model == "P"){p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  filter(variable == "Recruit") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior, x = year , color = variable, fill = variable), alpha = 0.5)+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  scale_fill_manual(values = c( "#00BFC4"))+
  scale_color_manual(values = c("#00BFC4"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10', labels = scales::label_comma())+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 15),strip.text = element_text(size = 15),axis.title.y = element_blank())}
  if(model == "A"){
p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  filter(variable == "Immigrant") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior, x = year , color = variable, fill = variable), alpha = 0.5)+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  scale_fill_manual(values = c( "#F8766D"))+
  scale_color_manual(values = c("#F8766D"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10')+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 15),strip.text = element_text(size = 15),axis.title.y = element_blank())
  }

#add shade to heatwave
# p + annotate("rect", xmin = 14.5,xmax = 17.5,ymin = -Inf, ymax = Inf, fill = "red", alpha = 0.2)+ #add box around blob
# geom_text()

f <- data.frame(test %>% select("F","nb.k")) %>% 
  pivot_longer(cols = c("F","nb.k"),names_to = "var",values_to = "posterior") %>% 
  ggplot(aes(x = var, y = posterior))+
  geom_violin( fill = "lavender")+
  facet_wrap(~var, scales = "free")+
  theme_bw()+
  theme(axis.title.x = element_blank(),axis.text = element_text(size = 15),strip.text = element_text(size = 15),axis.title = element_text(size = 15),
        strip.text.x = element_blank())
  # stat_summary(fun = "median",
  #              geom = "text")

(f+p+plot_layout(widths = c(3, 15)))+ggtitle(ggtitle)
}

y = as.character(c(2000:2022)) #column titles for years
y.m = as.character(c(2009:2022)) #column titles for mitigation years
density.plot <- function(data,post.fit,fix.param, transect, year_name,ipm.i, ipm.r, ggtitle ){
  
t.sect <- data.frame( t(transect)) %>%
  mutate(year = as.character(rownames(.)))

# #### Survey density
tfish <- data %>% add_column(size = c(1:nrow(data))) %>%
  pivot_longer(cols = c(1:length(data)), names_to = "year",values_to = "count") %>%
  left_join(., t.sect) %>%
  mutate(density = count/t.transect.)

#size distribution from ipm using median values
median <- c(unname( sapply(data.frame(post.fit$Values), median)))
names(median) <- colnames(post.fit$Values)

ipm.plot <- run.IPM(fix.param = fix.param, cand.param = median, Data =  data, burnin = FALSE, ipm.i = ipm.i,ipm.r = ipm.r)

sizedist <- data.frame(ipm.plot$N)

tipm <- sizedist %>% select(c(1:ncol(sizedist))) %>% #IPM with data fitting
  rename_all(~year_name) %>%  #rename columns to match year
  add_column(size = c(1:nrow(sizedist))) %>% #add sizes
  mutate(size = size*fix.param$dx) %>%
  pivot_longer(cols = 1:ncol(sizedist),
               names_to = "year",
               values_to = "N") %>%
  group_by(year)

plot <- ggplot()+
  geom_line(data = tfish, aes(x = size, y = density*10000), color = "black", linewidth = 0.4) +
  geom_line(data = tipm, aes(x = size, y = N*10000), color = "red")+
  facet_wrap(~year, scales = "free_y") +
  scale_y_continuous("Individual per hectare", labels = scales::label_comma()) +
    theme_bw()+
  lims(x = c(0,80))+
  labs(x = "Length (cm)")+
  ggtitle(ggtitle)+
  theme(legend.position = "none",
        axis.text = element_text(size = 15),strip.text = element_text(size = 15),
        title = element_text(size = 15))

return(plot)
}

```

### California Sheephead
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.sepu, "p.a.sepu")
# ggsave("trace.p.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.sepu,"a.sepu")
# ggsave("trace.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.sepu,"p.sepu")
# ggsave("trace.p.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#mitigation reef
trace.plot(Post.fit.p.a.mitigation, "p.a.sepu.m")
# ggsave("trace.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.mitigation,"a.sepu.m")
# ggsave("trace.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.mitigation,"p.sepu.m")
# ggsave("trace.p.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.sepu, Post.fit.p.a.sepu, model = "PA", ggtitle = "p.a.sepu")
# ggsave("posterior.p.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

# posterior.plot(fishtotal.m.sepu, Post.fit.p.a.mitigation, model = "PA", ggtitle = "p.a.sepu.m")
posterior.plot(fishtotal.m.sepu, Post.fit.p.a.mitigation, model = "PA", ggtitle = "p.a.sepu.m")
# ggsave("posterior.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
# posterior.plot(fishtotal.m.sepu, Post.fit.a.mitigation, model = "A", ggtitle = "a.sepu.m")

#experimental reef
density.plot(data = fishtotal.sepu, post.fit = Post.fit.p.a.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.sepu")
# ggsave("density.p.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.sepu, post.fit = Post.fit.p.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.sepu")
# ggsave("density.p.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.sepu, post.fit = Post.fit.a.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.sepu")
# ggsave("density.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#mitigation reef
density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.p.a.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.sepu.m")
# ggsave("density.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.p.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.sepu.m")
# ggsave("density.p.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.a.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.sepu.m")
# ggsave("density.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

```

### Kelp Bass
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.pacl, "p.a.pacl")
# ggsave("trace.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.pacl,"a.pacl")
# ggsave("trace.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.pacl,"p.pacl")
# ggsave("trace.p.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

trace.plot(Post.fit.p.a.pacl.m, "p.a.pacl.m")
# ggsave("trace.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.pacl.m,"a.pacl.m")
# ggsave("trace.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.pacl.m,"p.pacl.m")
# ggsave("trace.p.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.pacl, Post.fit.p.a.pacl, model = "PA", ggtitle = "p.a.pacl")
# ggsave("posterior.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

posterior.plot(fishtotal.m.pacl, Post.fit.p.a.pacl.m, model = "PA", ggtitle = "p.a.pacl.m")
# ggsave("posterior.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#density plot - experimental reef
density.plot(data = fishtotal.pacl, post.fit = Post.fit.p.a.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pacl")
# ggsave("density.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.pacl, post.fit = Post.fit.p.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pacl")
# ggsave("density.p.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.pacl, post.fit = Post.fit.a.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pacl")
# ggsave("density.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#mitigation reef
density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.p.a.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pacl.m")
# ggsave("density.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.p.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pacl.m")
# ggsave("density.p.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.a.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pacl.m")
# ggsave("density.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
```

### Barred Sandbass
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.pane, "p.a.pane")
# ggsave("trace.p.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.pane,"a.pane")
# ggsave("trace.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.pane,"p.pane")
# ggsave("trace.p.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

trace.plot(Post.fit.p.a.pane.m, "p.a.pane.m")
# ggsave("trace.p.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.a.pane.m,"a.pane.m")
# ggsave("trace.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
trace.plot(Post.fit.p.pane.m,"p.pane.m")
# ggsave("trace.p.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.pane, Post.fit.p.a.pane, model = "PA", ggtitle = "p.a.pane")
# ggsave("posterior.p.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

posterior.plot(fishtotal.m.pane, Post.fit.p.a.pane.m, model = "PA", ggtitle = "p.a.pane.m")
# ggsave("posterior.p.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#density plot - experimental reef
density.plot(data = fishtotal.pane, post.fit = Post.fit.p.a.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pane")
# ggsave("density.p.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.pane, post.fit = Post.fit.p.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pane")
# ggsave("density.p.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.pane, post.fit = Post.fit.a.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pane")
# ggsave("density.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

#mitigation reef
density.plot(data = fishtotal.m.pane, post.fit = Post.fit.p.a.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pane.m")
# ggsave("density.p.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.pane, post.fit = Post.fit.p.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pane.m")
# ggsave("density.p.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))

density.plot(data = fishtotal.m.pane, post.fit = Post.fit.a.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pane.m")
# ggsave("density.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("output","plots"))
```



## Summary of posteriors (individuals per hectare)
```{r}
#immigration 
summary(c(sapply(data.frame(Post.fit.p.a.pane$Values[,c(24:46)])*10000, median)))
summary(c(sapply(data.frame(Post.fit.p.a.pane.m$Values[,c(15:28)])*10000, median)))

#Recruitment
summary(c(sapply(data.frame(Post.fit.p.a.pane$Values[,c(1:23)])*10000, median)))
summary(c(sapply(data.frame(Post.fit.p.a.pane.m$Values[,c(1:14)])*10000, median)))

#Fishing mortality
median(Post.fit.p.a.pane$Values[,47]) 
median(Post.fit.p.a.pane.m$Values[,29])

#Dispersion
median(Post.fit.p.a.pane$Values[,48]) 
median(Post.fit.p.a.pane.m$Values[,30])
```


## Plots

### Transect trend
```{r}
songs %>% 
  filter(phase_built_code %in% c("E", "M", "NA"),
         transtype_strata %in% c("BOTTOM",NA),
         species_code == "SEPU") %>%
  pivot_wider(names_from = total_length, values_from = count) %>% mutate(count = 1) %>% summarise(transect = sum(count), .by = c(year,reef_code,phase_built_code)) %>% ggplot()+
  geom_col(aes(x = year, y = transect, fill = phase_built_code), position = position_dodge(), color = "gray22", width = 0.8)+
  scale_fill_viridis_d()+
  # facet_wrap(~phase_built_code)+
  labs(fill = "Reef", y = "Transect (n)")+
  theme_bw()
  # scale_fill_manual(labels = c("Experimental","Mitigation"), values = c("blue","red"))
```

### Number of fish observed
```{r}
songs %>% 
  filter(phase_built_code %in% c("E", "M", "NA"),
         transtype_strata %in% c("BOTTOM",NA),
         species_code %in% c("SEPU","PACL","PANE")) %>%
  uncount(count) %>% 
  mutate(n = 1) %>% 
  summarise(count = sum(n), .by = c(year,phase_built_code, species_code)) %>% 
  ggplot()+
  geom_col(aes(x = year, y = count, group = species_code, fill = species_code), position = position_dodge(), color = "black", width = 0.8)+
  facet_wrap(~phase_built_code)+
  scale_fill_viridis_d()+
  geom_hline(yintercept = 100, linetype = "dashed")+
  labs(fill = "Species")+
  theme_bw()
```


#### TEST size distribution
```{r}
#####------------- Immigration size distribution
## postfit.a
# Names <- c(paste0("i",c(1:(dim(fishtotal)[2]))), 'F')
# Means <- c(unname( sapply(data.frame(Post.fit_a$Values[,24:47]), median)))
# SDs <- c( rep(i.sd,dim(fishtotal)[2]), F.sd)
# Type <- c( rep('lognormal',dim(fishtotal)[2]), "lognormal") #type for recruitment,

## postfit.p
# Names <- c(paste0("r",c(1:(dim(fishtotal)[2]))), 'F')
# Means <- c(unname( sapply(data.frame(Post.fit_p$Values[,c(1:23,47)]), median)))
# SDs <- c(rep(r.sd,dim(fishtotal)[2]), F.sd)
# Type <- c(rep('lognormal',dim(fishtotal)[2]), "lognormal") #type for recruitment, immigration, fishing, and process error

## postfit.a_p
# Names <- c(paste0("r",c(1:(dim(fishtotal)[2]))),paste0("i",c(1:(dim(fishtotal)[2]))), 'F')
# Means <- c(unname( sapply(data.frame(Post.fit_p_a$Values[,1:47]), median)))
# SDs <- c(rep(r.sd,dim(fishtotal)[2]), rep(i.sd,dim(fishtotal)[2]), F.sd)
# Type <- c(rep('lognormal',dim(fishtotal)[2]), rep('lognormal',dim(fishtotal)[2]), "lognormal") #type for recruitment, immigration, fishing, and process error
# 
# Prior <- list(Names,Means,SDs,Type)
# names(Prior) <- c('Names','Means','SDs','Type')
# 
# 
# c(fix.param,Prior)
#   M = fix.param$MCMClen
#   Chains = fix.param$MCMCchains

######-------Immigration ipm--------########
# Names.im <- c(paste0("r",c(1:(dim(fishtotal)[2]))),paste0("i",c(1:(dim(fishtotal)[2]))), 'F')
#
# i.cand.param <-  c( rep(1,51), 0, 0.25,0) #use fixed cand.param F value
#       names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
#       i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
#       i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
#       i.ipm <- run.IPM(fix.param, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
#       stbstate <- i.ipm$N[,50] # Distant future based on IPM
#       stbstate[c(1:fix.param$Ifish)] <- 0 #exclude nonimmigrant sizes
#
#     #replace Ivec with new stable state distribution
#     fix.param$Ivec <- stbstate/sum(stbstate*fix.param$dx)
######-------Immigration wnr initial year--------########
# total_length <-data.frame(total_length =  c(1:nrow(fishtotal)))
# im.wnr.init <- songs %>%
#   filter( species_code == "SEPU",
#       year == 2000,
#          transtype_strata %in% c("BOTTOM",NA)) %>%
#   summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
#   drop_na(total_length) %>%
#   pivot_wider(names_from = year,values_from = tot_count) %>%
#   drop_na() %>%
#   filter(reef_code == "WNR") %>%  #data from one site
#   full_join(.,total_length) %>%
#   filter(total_length %in% c(1:max(total_length))) %>%
#   arrange(total_length) %>%  # re-order dataframe by numerical value
#   select(4) %>% # choose only count of fish
#   replace(is.na(.),0) %>% #add NA
#     # select("2000") %>%
#   mutate(sum = rowSums( across(where(is.numeric))))  # sum across the row
#
# tot.im.wnr.init <- data.frame( length = rownames(im.wnr.init), count = im.wnr.init$sum) %>%
#   uncount(count) %>% mutate(length = as.numeric(length)) # get overall value
#
# wnr.init.den <- density(tot.im.wnr.init$length)
# af <- approxfun(wnr.init.den$x,wnr.init.den$y) #linear approximation of the values from density plot values
# temp <- c(fix.param$x) #length interval
# a <- af(temp) # approximate density based on
# a[ is.na(a)  ] = 1e-323
# a[c(1:fix.param$Ifish)] <- 0 #recruits are not moving
# fix.param$Ivec <- a/sum(a*fix.param$dx)
# plot(cbind(temp,a))
######-------Immigration bk culmative size dist--------########
#
#       im.bk <- songs %>%
#   filter( species_code == "SEPU",
#           reef_code %in% c("BK"),
#          transtype_strata %in% c("BOTTOM",NA)) %>%
#   summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%
#   drop_na(total_length) %>%
#   pivot_wider(names_from = year,values_from = tot_count) %>%
#   drop_na() %>%
#   # filter(reef_code%in% c("BK","SMK")) %>%  #data from one site
#   full_join(.,total_length) %>%
#   filter(total_length %in% c(1:max(total_length))) %>%
#   arrange(total_length) %>%  # re-order dataframe by numerical value
#   select(4:length(fishtotal)) %>% # choose only count of fish
#   replace(is.na(.),0) %>% #add NA
#     # select("2000") %>%
#   mutate(sum = rowSums( across(where(is.numeric))))  # sum across the row
#
# tot.bk <- data.frame( length = rownames(im.bk), count = im.bk$sum) %>%
#   uncount(count) %>% mutate(length = as.numeric(length)) # get overall value
#
# bk.den <- density(tot.bk$length)
# af <- approxfun(bk.den$x,bk.den$y) #linear approximation of the values from density plot values
# temp <- c(fix.param$x) #length interval
# a <- af(temp) # approximate density based on
# a[ is.na(a)  ] = 1e-323
# a[c(1:fix.param$Ifish)] <- 0
# fix.param$Ivec <- a/sum(a*fix.param$dx)
# #
# plot(cbind(temp,a))
# a <- ggplot_build( ggplot(tot.bk)+
#   geom_density(aes(x = length), bw = fix.param$dx))
# b <- data.frame(a$data) %>% select(x,y)

######-------Immigration--------########
# 
# 
# Values <- data.frame(matrix(NA,nrow=1,ncol =length(Prior.pane$Names)))
# Values[1,] <- exp(Prior.pane$Means)
# colnames(Values) <- Names
# test <- run.IPM(fix.param = fix.param.pane, cand.param =  Values, fishtotal.pane, burnin = FALSE)
# sizedist <- data.frame(test$N)
# 
# #
# #
# y = as.character(c(2000:2022))
# t.sect <- data.frame( t(transect)) %>%
#   mutate(year = as.character(rownames(.)))
# # #### Survey density
# tfish <- fishtotal.pane %>% add_column(size = c(1:nrow(fishtotal.pane)), .before = '2000') %>%
#   pivot_longer(cols = c("2000":"2022"), names_to = "year",values_to = "count") %>%
#   left_join(., t.sect) %>%
#   mutate(density = count/t.transect.)
# 
# tipm <- sizedist %>% select(c(1:23)) %>% #IPM with data fitting
#   rename_all(~y) %>%  #rename columns to match year
#   add_column(size = c(1:nrow(sizedist)), .before = '2000') %>% #add sizes
#   mutate(size = size*fix.param.sepu$dx) %>%
#   pivot_longer(cols = "2000":"2022",
#                names_to = "year",
#                values_to = "N") %>%
#   group_by(year)
# 
# ggplot()+
#   geom_line(data = tipm, aes(x = size, y = N), color = "red")+
#   geom_line(data = tfish, aes(x = size, y = density, color = "Survey density"), linetype = "dashed") +
#   facet_wrap(~year, scales = "free_y") +
#   scale_y_continuous("survey density", labels = scales::label_comma()) +
#     theme_bw()+
#   lims(x = c(0,80))+
#   labs(x = "Length (cm)")+
#   ggtitle("Attraction & Production IPM fit to data")+
#   theme(legend.position = "none",
#         axis.text = element_text(size = 15),strip.text = element_text(size = 15),
#         title = element_text(size = 15))


######--------- compare ipm im size distr to data
# total_length <-data.frame(total_length =  c(1:nrow(fishtotal)))
# reef <- data.frame(reef_code= c("WNR","BK","SMK"))
# lengthxreef <- cross_join(total_length,reef)
# 

transect.smk <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA)) %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'SMK') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")%>% # make longer data frame
  pivot_longer(cols = c(1:23), names_to = "year", values_to = "area_surveyed") %>% 
  mutate(year = as.factor(year),
         "reef_code" ='SMK')


transect.wnr <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA)) %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")%>%  #make longer data frame
  pivot_longer(cols = c(1:23), names_to = "year", values_to = "area_surveyed") %>% 
  mutate(year = as.factor(year),
         "reef_code" ='WNR')


transect.reefs <- bind_rows(transect.wnr,transect.smk) %>% mutate(reef_code = as.factor(reef_code))

#SMK fish density of non-recruits
im.data <- songs %>%
  filter( species_code %in% c("SEPU","PACL","PANE"),
          reef_code %in% c("SMK",'WNR'),
         transtype_strata %in% c("BOTTOM",NA),
         phase_built_code%in% c("N","E","M")) %>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code,phase_built_code, total_length )) %>%
  drop_na(total_length) %>%
  pivot_wider(names_from = year, values_from = tot_count) %>%
  # full_join(.,lengthxreef) %>%
  # mutate(species_code = "SEPU") %>%
  replace(is.na(.),0) %>%
  pivot_longer(cols = c('2000':'2022'),
               names_to = "year",values_to = "count") %>%
  mutate(year = as.factor(year)) %>% 
  left_join(.,transect.reefs) %>% 
  filter(total_length>8) %>% # Only juvenile and adult fishes
  summarise(sum = sum(count), .by = c(year,reef_code,species_code,phase_built_code,area_surveyed)) %>% 
  mutate(density = sum/area_surveyed)

#actualy values 
im.data %>% 
  # filter(total_length>8) %>%  summarise(sum = sum(density), .by = c(year,species_code)) %>% 
  ggplot() + 
  # geom_line(aes(x = year, y = density*10000, group = species_code, color = species_code))+
  # geom_point(aes(x = year, y = density*10000, group = species_code, color = species_code), fill = "black")+
  geom_col(aes(x = year, y = density*10000, group = species_code, fill = species_code),color = "grey20", position = "dodge", width = 0.7 )+
  theme_bw()+
  scale_fill_viridis_d()+
  labs(y = "Individuals per hectare", x = element_blank(), fill = "Species")+
  facet_wrap(~phase_built_code)+ 
  theme(axis.text.x = element_text(angle = 270, vjust = 0.5, hjust=1, size = 12), axis.text.y = element_text(size = 10))
  
################## Median
im.mean <- songs %>%
  filter( species_code %in% c("SEPU","PACL","PANE"),
          reef_code %in% c("SMK",'WNR'),
         transtype_strata %in% c("BOTTOM",NA),
         phase_built_code%in% c("N","E","M")) %>%
  summarise(tot_count = sum(count), .by = c(year, reef_code,phase_built_code, species_code, total_length )) %>%
  drop_na(total_length) %>%
  pivot_wider(names_from = year, values_from = tot_count) %>%
  # full_join(.,lengthxreef) %>%
  # mutate(species_code = "SEPU") %>%
  replace(is.na(.),0) %>%
  pivot_longer(cols = c('2000':'2022'),
               names_to = "year",values_to = "count") %>%
  # mutate(year = as.factor(year)) %>%
  left_join(.,transect.reefs) %>%
  # filter(total_length>8) %>% # Only juvenile and adult fishes
  uncount(count) %>%
  mutate(tally = 1) %>% 
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            n = sum(tally),
            .by = c(reef_code,phase_built_code,species_code,year)) %>% 
  mutate(up_cl =mean+ (sd/sqrt(n)),
         low_cl = mean - (sd/sqrt(n))) %>% 
  mutate(year = as.factor(year))
  

im.mean %>%  ggplot() + geom_line(aes(x = year, y = mean, group = species_code, color = species_code) )+ 
  geom_point(aes(x = year, y = mean, group = species_code, color = species_code), alpha = 0.6 )+
  geom_ribbon(aes(x = year, ymax = up_cl,ymin = low_cl,group =species_code,fill = species_code),alpha = 0.2)+
  theme_bw()+
  scale_color_viridis_d( option = "H")+
  scale_fill_viridis_d()+
  labs(y = "Survey Mean size (cm)", x = element_blank(), fill = "Species", color = "Species")+
  facet_wrap(~phase_built_code)+
  theme(axis.text.x = element_text(angle = 270, vjust = 0.5, hjust=1, size = 12), axis.text.y = element_text(size = 10))
```
 
```{r}
#TEST Check recruitment density

#PACL phase1
fishtotal.pacl[c(1:8),] %>% pivot_longer(cols = c(1:23), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year) %>% left_join(.,as.data.frame(transect) %>% pivot_longer(c(1:23), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))
#phase2
fishtotal.m.pacl[c(1:8),] %>% pivot_longer(cols = c(1:14), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year) %>% left_join(.,as.data.frame(transect_mitigation) %>% pivot_longer(c(1:14), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))

#SEPU phase1
fishtotal.sepu[c(1:8),] %>% pivot_longer(cols = c(1:23), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year) %>% left_join(.,as.data.frame(transect) %>% pivot_longer(c(1:23), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))
#phase2
fishtotal.m.sepu[c(1:8),] %>% pivot_longer(cols = c(1:14), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year) %>% left_join(.,as.data.frame(transect_mitigation) %>% pivot_longer(c(1:14), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))

#PANE phase 1
fishtotal.pane[c(1:8),] %>% pivot_longer(cols = c(1:23), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year)
# left_join(.,as.data.frame(transect) %>% pivot_longer(c(1:23), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))
#phase2
fishtotal.m.pane[c(1:8),] %>% pivot_longer(cols = c(1:14), names_to = "year",values_to = "count") %>% summarise(sum = sum(count), .by = year) 
# left_join(.,as.data.frame(transect_mitigation) %>% pivot_longer(c(1:14), names_to = "year",values_to = "transect")) %>% mutate("density" = sum/transect) %>% select(c(year, density))
```
 
 