
---
title: "SSIPM_master"
author: "Will White"
date: '2023-01-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

SSIPM Code for Nickols et al. SONGS artificial reefs project
Author: Will White
Based on code in White et al. 2016 Ecol Appl and subsequent modifications


```{r}
# load necessary libraries (including eventually the SSIPM library)
# library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(readr)
library(purrr)
library(tibble)
library(patchwork)
library(stringr)
library(forcats)
library(lubridate) 
library(scales) #accessory to plotting ggplot
# library(bbmle) # library for maximum likelihood calculation
# library(invgamma)#library for inverse gamma
# #library for parallel processing
# library(doParallel)

library(here)
source(here("SSIPM","calculate.prior.R"))
source(here("SSIPM","create.params.R"))
source(here("SSIPM","fit.SSIPM.MCMC.R"))
source(here("SSIPM","get.cand.R"))
source(here("SSIPM","kernmat.R"))
source(here("SSIPM","run.IPM.R"))
source(here("SSIPM","postproc.MCMC.R"))
source(here("SSIPM","ssipm.dic.R"))
source(here("SSIPM","post.pred.check.R"))
```

# Read in data
```{r}
# Read in data
# This will work best if the data are arranged as abundance in each length bin on the rows, with a column for each annual observation. Missing years should be a column of NAs

{

{
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/668/4/60afbd5190f50ba5271dacdf74e549f3"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")


 dt1 <-read.csv(infile1,header=F
          ,skip=1
            ,sep=","
        , col.names=c(
                    "year",
                    "date",
                    "reef_code",
                    "polygon",
                    "phase_built_code",
                    "transect_code",
                    "visibility",
                    "species_code",
                    "genus_name",
                    "species_name",
                    "count",
                    "total_length",
                    "total_area_sampled"    ), check.names=TRUE)

unlink(infile1)

# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings

if (class(dt1$date)!="factor") dt1$date<- as.factor(dt1$date)
if (class(dt1$reef_code)!="factor") dt1$reef_code<- as.factor(dt1$reef_code)
if (class(dt1$polygon)!="factor") dt1$polygon<- as.factor(dt1$polygon)
if (class(dt1$phase_built_code)!="factor") dt1$phase_built_code<- as.factor(dt1$phase_built_code)
if (class(dt1$transect_code)!="factor") dt1$transect_code<- as.factor(dt1$transect_code)
if (class(dt1$visibility)=="factor") dt1$visibility <-as.numeric(levels(dt1$visibility))[as.integer(dt1$visibility) ]
if (class(dt1$visibility)=="character") dt1$visibility <-as.numeric(dt1$visibility)
if (class(dt1$species_code)!="factor") dt1$species_code<- as.factor(dt1$species_code)
if (class(dt1$genus_name)!="factor") dt1$genus_name<- as.factor(dt1$genus_name)
if (class(dt1$species_name)!="factor") dt1$species_name<- as.factor(dt1$species_name)
if (class(dt1$count)=="factor") dt1$count <-as.numeric(levels(dt1$count))[as.integer(dt1$count) ]
if (class(dt1$count)=="character") dt1$count <-as.numeric(dt1$count)
if (class(dt1$total_length)=="factor") dt1$total_length <-as.numeric(levels(dt1$total_length))[as.integer(dt1$total_length) ]
if (class(dt1$total_length)=="character") dt1$total_length <-as.numeric(dt1$total_length)
if (class(dt1$total_area_sampled)=="factor") dt1$total_area_sampled <-as.numeric(levels(dt1$total_area_sampled))[as.integer(dt1$total_area_sampled) ]
if (class(dt1$total_area_sampled)=="character") dt1$total_area_sampled <-as.numeric(dt1$total_area_sampled)

# Convert Missing Values to NA for non-dates

dt1$date <- as.factor(ifelse((trimws(as.character(dt1$date))==trimws("-99999")),NA,as.character(dt1$date)))
dt1$reef_code <- as.factor(ifelse((trimws(as.character(dt1$reef_code))==trimws("-99999")),NA,as.character(dt1$reef_code)))
dt1$polygon <- as.factor(ifelse((trimws(as.character(dt1$polygon))==trimws("-99999")),NA,as.character(dt1$polygon)))
dt1$phase_built_code <- as.factor(ifelse((trimws(as.character(dt1$phase_built_code))==trimws("-99999")),NA,as.character(dt1$phase_built_code)))
dt1$transect_code <- as.factor(ifelse((trimws(as.character(dt1$transect_code))==trimws("-99999")),NA,as.character(dt1$transect_code)))
dt1$visibility <- ifelse((trimws(as.character(dt1$visibility))==trimws("-99999")),NA,dt1$visibility)
suppressWarnings(dt1$visibility <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$visibility))==as.character(as.numeric("-99999"))),NA,dt1$visibility))
dt1$species_code <- as.factor(ifelse((trimws(as.character(dt1$species_code))==trimws("-99999")),NA,as.character(dt1$species_code)))
dt1$genus_name <- as.factor(ifelse((trimws(as.character(dt1$genus_name))==trimws("-99999")),NA,as.character(dt1$genus_name)))
dt1$species_name <- as.factor(ifelse((trimws(as.character(dt1$species_name))==trimws("-99999")),NA,as.character(dt1$species_name)))
dt1$count <- ifelse((trimws(as.character(dt1$count))==trimws("-99999")),NA,dt1$count)
suppressWarnings(dt1$count <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$count))==as.character(as.numeric("-99999"))),NA,dt1$count))
dt1$total_length <- ifelse((trimws(as.character(dt1$total_length))==trimws("-99999")),NA,dt1$total_length)
suppressWarnings(dt1$total_length <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_length))==as.character(as.numeric("-99999"))),NA,dt1$total_length))
dt1$total_area_sampled <- ifelse((trimws(as.character(dt1$total_area_sampled))==trimws("-99999")),NA,dt1$total_area_sampled)
suppressWarnings(dt1$total_area_sampled <- ifelse(!is.na(as.numeric("-99999")) & (trimws(as.character(dt1$total_area_sampled))==as.character(as.numeric("-99999"))),NA,dt1$total_area_sampled))


# Here is the structure of the input data frame:
str(dt1)
attach(dt1)
# The analyses below are basic descriptions of the variables. After testing, they should be replaced.

summary(year)
summary(date)
summary(reef_code)
summary(polygon)
summary(phase_built_code)
summary(transect_code)
summary(visibility)
summary(species_code)
summary(genus_name)
summary(species_name)
summary(count)
summary(total_length)
summary(total_area_sampled)
                # Get more details on character variables

summary(as.factor(dt1$date))
summary(as.factor(dt1$reef_code))
summary(as.factor(dt1$polygon))
summary(as.factor(dt1$phase_built_code))
summary(as.factor(dt1$transect_code))
summary(as.factor(dt1$species_code))
summary(as.factor(dt1$genus_name))
summary(as.factor(dt1$species_name))
detach(dt1)


  phase2_3 <- dt1 %>%
    filter(species_code %in% c("PACL", "OXCA", "PANE",
                               "CHPU", "EMJA", "SEPU")) %>%
    filter(case_when(year == 2009 ~ total_area_sampled == 100, T~ total_area_sampled %in% c(150,123)))
} #phase 2 & 3 data from public repository
{
  
  condpath <- here("data","songs_phase1") 
  files <- dir(path = condpath,
               pattern = ".csv",
               full.names = TRUE)
  songs_1 <- files %>% #iterating over files
    set_names(nm = files) %>% # set the id for everything in "files"
    map_df(read_csv, .id = "filename") %>% 
    mutate(polygon = as.factor(polygon), date_survey = ymd(date)) %>% 
    # filter(total_area_sampled >60) %>% 
    mutate(month = month(date_survey)) %>% 
    filter(month != 2) %>% 
    dplyr::select(-c(month,date_survey))
  } #add phase 1 data from data folder

  years <- data.frame(year = c(2000:2022))
  # songs <- songs_1 %>% dplyr::select(3:18) ########!!!!!!!!!!! Temp. using Phase1 data only
  songs <- bind_rows(songs_1,phase2_3) %>%
    select(3:18)
  songs <- left_join(years, songs)
}
```

# Wrangle data

### Filter for experimental reef data & benthic transect
```{r}
#get total count - values from Phase 1 reefs ONLY, Bottom transect
songstotal <- songs %>% 
  filter(phase_built_code == "E", 
         transtype_strata %in% c("BOTTOM",NA))%>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
  drop_na(total_length) %>% 
  pivot_wider(names_from = year,values_from = tot_count) %>% 
  drop_na() %>% 
  filter(reef_code == "WNR") #data from one site

#filter one species 
fishtotal.sepu <- songstotal[which(songstotal$species_code == "SEPU"),] 
fishtotal.pacl <- songstotal[which(songstotal$species_code == "PACL"),] 
fishtotal.pane <- songstotal[which(songstotal$species_code == "PANE"),] 


```

### Arrange data
```{r}
#arrange to have a row for every size bin (1cm increment)

#California Sheephead
fishtotal.sepu <- fishtotal.sepu %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.sepu$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.sepu)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:114))) %>%      # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  arrange(total_length) %>% #make ascending order
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>%    # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)

# Kelp Bass
fishtotal.pacl <- fishtotal.pacl %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.pacl$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pacl)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:140))) %>%  # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  arrange(total_length) %>% #make ascending order
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>% # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)
  
# Barred Sandbass
fishtotal.pane <- fishtotal.pane %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.pane$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pane)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:122))) %>%  # Match data length to fit IPM mesh size (equal to fix.param$meshmax)
  arrange(total_length) %>% #make ascending order
  replace(is.na(.),0) %>% #add NA
  add_column("2008" = NA, "2007" = NA) %>%    # add years not surveyed to be continuous
  relocate(c("2007","2008"), .after = "2006") %>%
  dplyr::select(!total_length)

```

### Filter for mitigation reef data & benthic transect
```{r}
#get total count - values from Phase 2 reefs ONLY, Bottom transect
songstotal.mitigation <- songs %>% 
  filter(phase_built_code == "M", 
         transtype_strata %in% c("BOTTOM",NA))%>%
  summarise(tot_count = sum(count), .by = c(year, reef_code, species_code, total_length )) %>%
  drop_na(total_length) %>% 
  pivot_wider(names_from = year,values_from = tot_count) %>% 
  drop_na() %>% 
  filter(reef_code == "WNR") #data from one site

#filter one species 
fishtotal.m.sepu <- songstotal.mitigation[which(songstotal.mitigation$species_code == "SEPU"),] 

fishtotal.m.pacl <- songstotal.mitigation[which(songstotal.mitigation$species_code == "PACL"),] 

fishtotal.m.pane <- songstotal.mitigation[which(songstotal.mitigation$species_code == "PANE"),] 

```

### Arrange data
```{r}
#California Sheephead

#arrange to have a row for every size bin (1cm increment)
fishtotal.m.sepu <- fishtotal.m.sepu %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.sepu$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.sepu)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:114))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)

#Kelp Bass
fishtotal.m.pacl <- fishtotal.m.pacl %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.pacl$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.pacl)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:140))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)

#Barred Sandbass
fishtotal.m.pane <- fishtotal.m.pane %>%
  filter(total_length != 0) %>%  #remove zero length so length is flush with row number
  filter(total_length %in% c(1:max(fishtotal.m.pane$total_length))) %>%
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.m.pane)) %>% # choose only count of fish
  full_join(., data.frame( total_length = c(1:122))) %>%  # Match data length to fit IPM mesh size
  replace(is.na(.),0) %>% #add NA
  dplyr::select(!total_length)
```

# Transect area surveyed per year
```{r}
#Define the number of transects and total area surveyed

#phase 1 reef
transect <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA),
         phase_built_code == "E") %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")
transect <- as.matrix(transect)

# phase 2 reef
transect_mitigation <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA),
         phase_built_code == "M") %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area)
transect_mitigation <- as.matrix(transect_mitigation)
```

# Regulation list
```{r}
#Define the years of survey and corresponding regulation for Kelp Bass and Barred Sandbass, and check it matches with the year regulation was changed. Both species have the same fishing regualtions.
years <- colnames(fishtotal.sepu)
datyr <- c(1:dim(fishtotal.sepu)[2])
regulation <- c(rep("1",length(c(2000:2012))), rep("2",length(c(2013:2022))))

years <- colnames(fishtotal.m.sepu)
datyr <- c(1:dim(fishtotal.m.sepu)[2])
regulation.m <- c(rep("1",length(c(2009:2012))), rep("2",length(c(2013:2022))))


```

# Fixed Parameters

### California Sheephead
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'SEPU'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.sepu <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.sepu$correction <- transect #add survey correction to fix.params
fix.param.sepu$error <- 0.05 #fixed process error
fix.param.sepu$regulation <- NULL #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.sepu <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.sepu$correction <- transect_mitigation
fix.param.m.sepu$error <- 0.05 #fixed process error
fix.param.m.sepu$regulation <- NULL #No change in regulation occured

```

### Kelp Bass
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'PACL'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.pacl <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.pacl$correction <- transect #add survey correction to fix.params
fix.param.pacl$error <- 0.05 #fixed process error
fix.param.pacl$regulation <- regulation #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.pacl <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.pacl$correction <- transect_mitigation
fix.param.m.pacl$error <- 0.05 #fixed process error
fix.param.m.pacl$regulation <- regulation.m #Insert identifier for changes in regulation
```

### Barred Sandbass
```{r}
# Define the species to be examined and generate a list of fixed demographic parameters and IPM attributes/metadata
Sp <- 'PANE'
meshsize = 100
MCMClen = 10^4 # how long are MCMC chains
MCMCchains = 3 # how many chains

# we may be missing a few necessary parameters in create.params()...add in as needed
fix.param.pane <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.pane$correction <- transect #add survey correction to fix.params
fix.param.pane$error <- 0.05 #fixed process error
fix.param.pane$regulation <- regulation #No change in regulation occured

#phase 2 mitigation reef
fix.param.m.pane <- create.params(Sp = Sp, MCMClen = MCMClen,MCMCchains = MCMCchains) # fix.param will be handy to pass around arguments to other functions
fix.param.m.pane$correction <- transect_mitigation
fix.param.m.pane$error <- 0.05 #fixed process error
fix.param.m.pane$regulation <- regulation.m #Insert identifier for changes in regulation
```


# Immigration size distribution based on survey data from natural reef (SMK)

### California Sheephead
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "SEPU",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "SEPU", total_length = c(1:fix.param.sepu$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.sepu)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.sepu$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.sepu$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.sepu$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.sepu$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.25,0) #use fixed cand.param F value
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.ipm <- run.IPM(fix.param.sepu, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.sepu$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.sepu$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.sepu$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.sepu$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name
Ivec.sepu <- Ivec

#add to fix.param
fix.param.sepu <- c(fix.param.sepu,Ivec)

#add to fix.param.mitigation
Ivec.m.sepu <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.sepu) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.sepu)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.sepu <- c(fix.param.m.sepu,Ivec.m.sepu)
```

### Kelp Bass
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "PACL",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "PACL", total_length = c(1:fix.param.pacl$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pacl)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.pacl$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.pacl$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.pacl$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.pacl$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.12,0) #use fixed F value from literature
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.fix.param.pacl <- fix.param.pacl 
      i.fix.param.pacl$regulation <- rep(1,length(c(0:50))) #regulation match year of 
      i.ipm <- run.IPM(i.fix.param.pacl, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.pacl$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.pacl$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.pacl$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.pacl$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name
Ivec.pacl <- Ivec

#add to fix.param
fix.param.pacl <- c(fix.param.pacl,Ivec)

#add to fix.param.mitigation
Ivec.m.pacl <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.pacl) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.pacl)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.pacl <- c(fix.param.m.pacl,Ivec.m.pacl)
```

### Barred Sandbass
```{r}
#set up immigration size distribution based on survey data
#wrangle data
im.smk <- songs %>%
  filter( species_code == "PANE",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>% #get count per length
  drop_na(total_length) %>%
  pivot_wider(names_from = year,values_from = tot_count) %>%
  drop_na() %>%
  full_join(.,data.frame(species_code = "PANE", total_length = c(1:fix.param.pane$meshmax))) %>% #get all lengths,for the length of meshsize
  filter(total_length!=0) %>% #remove 0 length
  arrange(total_length) %>%  # re-order dataframe by numerical value
  dplyr::select(3:length(fishtotal.pane)) %>% # choose only count of fish
  replace(is.na(.),0) %>%   # NAs from added fish size = 0
  add_column("2008" = NA, "2007" = NA, "1999" = NA) %>%
  relocate(c("2007","2008"), .after = "2006") %>%
  relocate("1999", .before = "2000")

# turn every year with data into probability density size distribution
Ivec.name <-  c(paste0("Ivec",c(1:dim(im.smk)[2])),'Ivec0') #set up list
Ivec <- list()

df.ivec <- data.frame(matrix(nrow = nrow(im.smk),ncol = ncol(im.smk))) #place all ivec in data frame for plotting
names(df.ivec) <- names(im.smk)

#skip every year with NA data, otherwise change count into density
for(i in c(1: dim(im.smk)[2])){
  if(is.na(im.smk[1,i])){next} else{

    tot.smk <- data.frame( length = rownames(im.smk), count = im.smk[[i]]) %>%
    uncount(count) %>% mutate(length = as.numeric(length)) # count of length

    smk.den <- density(tot.smk$length) #density distribution at that year
    af <- approxfun(smk.den$x,smk.den$y) #linear approximation of the values from density plot
    temp <- c(fix.param.pane$x) #length interval
    a <- af(temp) # approximate density based on size bins
    a[ is.na(a)  ] = 1e-323 #give rest a minimum value
    a[c(1:fix.param.pane$Ifish)] <- 0 #assume yoy sized fish are not migrants=
  } #only years with data is calculated
   Ivec[[i]] <- a/sum(a*fix.param.pane$dx) #normalize to unity
   df.ivec[,i] <- a/sum(a*fix.param.pane$dx)
}

#for years without data, fill in with IPM generated stable-state size distribution
 for(i in 1: dim(im.smk)[2]){
if(is.na(im.smk[1,i])){

      i.cand.param <-  c( rep(1,51), 0, 0.12,0) #use fixed F value from literature
      names(i.cand.param) <- c(paste0("r",c(0:50)), "i",'F','error')
      i.data <- as.data.frame( matrix(NA,nrow = nrow(im.smk), ncol = ncol(im.smk)))
      i.data[,c(1:50)] <- NA #not reliant on data, and ran to distant future
      i.fix.param.pane <- fix.param.pane 
      i.fix.param.pane$regulation <- rep(1,length(c(0:50))) #regulation match years of missing survey
      i.ipm <- run.IPM(i.fix.param.pane, i.cand.param, i.data, burnin = FALSE, burnin.i = FALSE, ipm.i = FALSE)
      stbstate <- i.ipm$N[,50] # Distant future based on IPM
      stbstate[c(1:fix.param.pane$Ifish)] <- 0 #exclude non-immigrant sizes

      Ivec[[i]] <- stbstate/sum(stbstate*fix.param.pane$dx) #normalize to unity
      df.ivec[,i]<- stbstate/sum(stbstate*fix.param.pane$dx)
}
   Ivec$Ivec0 <- stbstate/sum(stbstate*fix.param.pane$dx) #add Ivec0 for initalizing burnin if needed
 }

#name list
names(Ivec) <- Ivec.name
Ivec.pane <- Ivec

#add to fix.param
fix.param.pane <- c(fix.param.pane,Ivec)

#add to fix.param.mitigation
Ivec.m.pane <- Ivec[10:25] #keep values of 2008 - 2022
names(Ivec.m.pane) <- c(paste0("Ivec",c(1:(dim(fishtotal.m.pane)[2]+1))),'Ivec0') #year 2008 corresponds to immigration 2009
fix.param.m.pane <- c(fix.param.m.pane,Ivec.m.pane)
```


# Size-dependent immigration function
Size dependent immigration funciton is used to correct for smaller fishes less likely to immigrate from one reef to another

Survey mean size and standard deviation across all years

### California Sheephead

```{r}
I.size.param <- songs %>%
  filter( species_code == "SEPU",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>% 
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>% 
  # filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>% 
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

I.size.fun.sepu <- pnorm(q = fix.param.sepu$x, mean = I.size.param$mean, sd = I.size.param$sd) #culumutive distribution function

# add to fixed parameters
fix.param.sepu$I.size <- I.size.fun.sepu
fix.param.m.sepu$I.size <- I.size.fun.sepu

```

### Kelp Bass 
Smaller fish more likely to move, larger adult fish more stationary (Lowe et al 2003)
```{r}
I.size.param <- songs %>%
  filter( species_code == "PACL",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>%
  filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>%
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

#complimentary cdf
I.size.fun.pacl <- 1-pnorm(q = fix.param.pacl$x, mean = I.size.param$mean, sd = I.size.param$sd) #cumulative distribution function

fix.param.pacl$I.size <- I.size.fun.pacl
fix.param.m.pacl$I.size <- I.size.fun.pacl

```

### Barred Sandbass 
larger fish have smaller home range (Mason & Lowe 2010)
```{r}
I.size.param <- songs %>%
  filter( species_code == "PANE",
          reef_code %in% c("SMK"),
         transtype_strata %in% c("BOTTOM",NA)) %>%
  summarise(tot_count = sum(count), .by = c(year, species_code, total_length )) %>%  # get total count per year per length bin
  drop_na(total_length) %>%
  # filter(!total_length <9) %>%  # remove recruit sized fish fish
  uncount(tot_count) %>%
  summarise(mean = mean(total_length),
            sd = sd(total_length),
            median = median(total_length),
            .by = year) %>% # mean and sd of years
  summarise(mean = mean(.$mean),
            sd = mean(.$sd)) # average across all years

#complementary cdf, for 50%
I.size.fun.pane <- (1-pnorm(q = fix.param.pane$x, mean = I.size.param$mean, sd = I.size.param$sd)*0.5)

fix.param.pane$I.size <- I.size.fun.pane
fix.param.m.pane$I.size <- I.size.fun.pane
```


# Priors

### California Sheephead
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.0025) # recruitment
r.sd <- 0.1
i.mean <- log(0.02) #immigration
i.sd <- 0.1
F.mean <- log(0.22) # fishing
F.sd <- 0.01
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.sepu)[2]))), paste0("i",c(1:(dim(fishtotal.sepu)[2]))), 'F', "nb.k")
Means <- c(rep(r.mean,dim(fishtotal.sepu)[2]), rep(i.mean,dim(fishtotal.sepu)[2]), F.mean,nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.sepu)[2]), rep(i.sd,dim(fishtotal.sepu)[2]), F.sd,nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.sepu)[2]),rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and  error
Prior.p.a.sepu <- list(Names,Means,SDs,Type)
names(Prior.p.a.sepu) <- c('Names','Means','SDs','Type')

# P
Names <- c(paste0("r",c(1:(dim(fishtotal.sepu)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.sepu)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.sepu)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and  error
Prior.p.sepu <- list(Names,Means,SDs,Type)
names(Prior.p.sepu) <- c('Names','Means','SDs','Type')

#A
Names <- c( paste0("i",c(1:(dim(fishtotal.sepu)[2]))), 'F','nb.k')
Means <- c( rep(i.mean,dim(fishtotal.sepu)[2]), F.mean, nb.k.mean)
SDs <- c(rep(i.sd,dim(fishtotal.sepu)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.sepu)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and  error
Prior.a.sepu <- list(Names,Means,SDs,Type)
names(Prior.a.sepu) <- c('Names','Means','SDs','Type')
```


```{r}
# phase 2 priors

# P & A 
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.sepu)[2]))), paste0("i",c(1:(dim(fishtotal.m.sepu)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.sepu)[2]), rep(i.mean,dim(fishtotal.m.sepu)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.sepu)[2]), rep(i.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.sepu)[2]),rep("lognormal",dim(fishtotal.m.sepu)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.sepu.m) <- c('Names','Means','SDs','Type')


# P  
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.sepu)[2]))),  'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.sepu)[2]),  F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.sepu)[2]),"lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.sepu.m) <- c('Names','Means','SDs','Type')

# A 
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.sepu)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(i.mean,dim(fishtotal.m.sepu)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.sepu)[2]), F.sd,nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.sepu)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.sepu.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.sepu.m) <- c('Names','Means','SDs','Type')
```


### Kelp Bass
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.0025) # recruitment
r.sd <- 0.1
i.mean <- log(0.01) #immigration
i.sd <- 0.1
F.mean <- log(0.12) # fishing
F.sd <- 0.1
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.pacl)[2]))), paste0("i",c(1:(dim(fishtotal.pacl)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pacl)[2]), rep(i.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pacl)[2]), rep(i.sd,dim(fishtotal.pacl)[2]), F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pacl)[2]),rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pacl <- list(Names,Means,SDs,Type)
names(Prior.p.a.pacl) <- c('Names','Means','SDs','Type')

# P 
Names <- c(paste0("r",c(1:(dim(fishtotal.pacl)[2]))),  'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pacl)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.pacl <- list(Names,Means,SDs,Type)
names(Prior.p.pacl) <- c('Names','Means','SDs','Type')

# A
Names <- c( paste0("i",c(1:(dim(fishtotal.pacl)[2]))), 'F','nb.k')
Means <- c( rep(i.mean,dim(fishtotal.pacl)[2]), F.mean, nb.k.mean)
SDs <- c( rep(i.sd,dim(fishtotal.pacl)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pacl <- list(Names,Means,SDs,Type)
names(Prior.a.pacl) <- c('Names','Means','SDs','Type')
```

```{r}
# phase 2 priors

# P & A
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pacl)[2]))), paste0("i",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pacl)[2]), rep(i.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pacl)[2]), rep(i.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.pacl)[2]),rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.pacl.m) <- c('Names','Means','SDs','Type')

# P
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.p.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.pacl.m) <- c('Names','Means','SDs','Type')

# A
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.pacl)[2]))), 'F','nb.k')
Means.mitigation <- c( rep(i.mean,dim(fishtotal.m.pacl)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.pacl)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pacl)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pacl.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.pacl.m) <- c('Names','Means','SDs','Type')

```

### Barred Sandbass
```{r}
# Set the priors for the parameters to be estimated...this list will need to be adjusted depending on the exact nature of the fitting we are doing
# for both recruitment & fishing is best done as lognormal.

r.mean <- log(0.001) # recruitment
r.sd <- 0.1
i.mean <- log(0.01) #immigration
i.sd <- 0.1
F.mean <- log(0.1) # fishing
F.sd <- 0.1
nb.k.mean <- log(1) #negative binomial overdisperison
nb.k.sd <- 0.1
# error.mean = 2 # process error shape
# error.sd = 0.025 # process error scale

# P & A
Names <- c(paste0("r",c(1:(dim(fishtotal.pane)[2]))), paste0("i",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pane)[2]), rep(i.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pane)[2]), rep(i.sd,dim(fishtotal.pane)[2]), F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pane)[2]),rep("lognormal",dim(fishtotal.pane)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pane <- list(Names,Means,SDs,Type)
names(Prior.p.a.pane) <- c('Names','Means','SDs','Type')

# P
Names <- c(paste0("r",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(r.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c(rep(r.sd,dim(fishtotal.pane)[2]),  F.sd, nb.k.sd)
Type <- c( c(rep("lognormal",dim(fishtotal.pane)[2]),"lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.pane <- list(Names,Means,SDs,Type)
names(Prior.p.pane) <- c('Names','Means','SDs','Type')

# A
Names <- c( paste0("i",c(1:(dim(fishtotal.pane)[2]))), 'F','nb.k')
Means <- c(rep(i.mean,dim(fishtotal.pane)[2]), F.mean, nb.k.mean)
SDs <- c( rep(i.sd,dim(fishtotal.pane)[2]), F.sd, nb.k.sd)
Type <- c( rep("lognormal",dim(fishtotal.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pane <- list(Names,Means,SDs,Type)
names(Prior.a.pane) <- c('Names','Means','SDs','Type')
```

```{r}
# phase 2 priors

# P & A
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pane)[2]))), paste0("i",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pane)[2]), rep(i.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pane)[2]), rep(i.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( c(rep("lognormal",dim(fishtotal.m.pane)[2]),rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal")) #type for recruitment, immigration, fishing, and process error
Prior.p.a.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.a.pane.m) <- c('Names','Means','SDs','Type')

# P
Names.mitigation <- c(paste0("r",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c(rep(r.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c(rep(r.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.p.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.p.pane.m) <- c('Names','Means','SDs','Type')

# A
Names.mitigation <- c( paste0("i",c(1:(dim(fishtotal.m.pane)[2]))), 'F','nb.k')
Means.mitigation <- c( rep(i.mean,dim(fishtotal.m.pane)[2]), F.mean, nb.k.mean)
SDs.mitigation <- c( rep(i.sd,dim(fishtotal.m.pane)[2]), F.sd, nb.k.sd)
Type.mitigation <- c( rep("lognormal",dim(fishtotal.m.pane)[2]), "lognormal", "lognormal") #type for recruitment, immigration, fishing, and process error
Prior.a.pane.m <- list(Names.mitigation,Means.mitigation,SDs.mitigation,Type.mitigation)
names(Prior.a.pane.m) <- c('Names','Means','SDs','Type')

```

#MCMC - Setup things for fitting via MCMC

### California Sheephead
```{r}
#California Sheephead

# Fit.p.a.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.p.a.sepu,'mc_str_ar_P_A_sepu.RData', burnin = FALSE)
# Fit.a.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.a.sepu,'mc_str_ar_A_sepu.RData', burnin = FALSE, ipm.r = FALSE)
# Fit.p.sepu <- fit.SSIPM.MCMC(fix.param.sepu,fishtotal.sepu,Prior.p.sepu,'mc_str_ar_P_sepu.RData', burnin = FALSE, ipm.i = FALSE)
# 
# Fit.p.a.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.p.a.sepu.m,'mc_str_ar_P_A_sepu_mitigation.RData', burnin = FALSE)
# Fit.p.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.p.sepu.m,'mc_str_ar_P_sepu_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# Fit.a.sepu.m <- fit.SSIPM.MCMC(fix.param.m.sepu,fishtotal.m.sepu,Prior.a.sepu.m,'mc_str_ar_A_sepu_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

### Kelp Bass
```{r}

# Fit.p.a.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.p.a.pacl,'mc_str_ar_P_A_pacl.RData', burnin = FALSE)
# Fit.p.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.p.pacl,'mc_str_ar_P_pacl.RData', burnin = FALSE,ipm.i = FALSE)
# Fit.a.pacl <- fit.SSIPM.MCMC(fix.param.pacl,fishtotal.pacl,Prior.a.pacl,'mc_str_ar_A_pacl.RData', burnin = FALSE,ipm.r = FALSE)
# # #
# Fit.p.a.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.p.a.pacl.m,'mc_str_ar_P_A_pacl_mitigation.RData', burnin = FALSE)
# # #
# Fit.p.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.p.pacl.m,'mc_str_ar_P_pacl_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# # #
# Fit.a.pacl.m <- fit.SSIPM.MCMC(fix.param.m.pacl,fishtotal.m.pacl,Prior.a.pacl.m,'mc_str_ar_A_pacl_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

### Barred Sandbass
```{r}
# Fit.p.a.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.p.a.pane,'mc_str_ar_P_A_pane.RData', burnin = FALSE)
# Fit.p.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.p.pane,'mc_str_ar_P_pane.RData', burnin = FALSE,ipm.i = FALSE)
# Fit.a.pane <- fit.SSIPM.MCMC(fix.param.pane,fishtotal.pane,Prior.a.pane,'mc_str_ar_A_pane.RData', burnin = FALSE,ipm.r = FALSE)
# #
# Fit.p.a.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.p.a.pane.m,'mc_str_ar_P_A_pane_mitigation.RData', burnin = FALSE)
# #
# Fit.p.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.p.pane.m,'mc_str_ar_P_pane_mitigation.RData', burnin = FALSE, ipm.i = FALSE)
# # #
# Fit.a.pane.m <- fit.SSIPM.MCMC(fix.param.m.pane,fishtotal.m.pane,Prior.a.pane,'mc_str_ar_A_pane_mitigation.RData', burnin = FALSE, ipm.r = FALSE)
```

# Call Rdata from files

### California Sheepehad
```{r}
load(here("SSIPM_output", "mc_str_ar_P_A_sepu.RData"))
Fit.p.a.sepu <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_sepu.RData"))
Fit.p.sepu <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_sepu.RData"))
Fit.a.sepu <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_A_sepu_mitigation.RData"))
Fit.p.a.sepu.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_sepu_mitigation.RData"))
Fit.p.sepu.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_sepu_mitigation.RData"))
Fit.a.sepu.m <- mc_str
```

### Kelp Bass
```{r}
load(here("SSIPM_output", "mc_str_ar_P_A_pacl.RData"))
Fit.p.a.pacl <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_pacl.RData"))
Fit.p.pacl <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_pacl.RData"))
Fit.a.pacl <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_A_pacl_mitigation.RData"))
Fit.p.a.pacl.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_pacl_mitigation.RData"))
Fit.p.pacl.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_pacl_mitigation.RData"))
Fit.a.pacl.m <- mc_str
```

### Barred Sandbass
```{r}
load(here("SSIPM_output", "mc_str_ar_P_A_pane.RData"))
Fit.p.a.pane <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_pane.RData"))
Fit.p.pane <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_pane.RData"))
Fit.a.pane <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_A_pane_mitigation.RData"))
Fit.p.a.pane.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_P_pane_mitigation.RData"))
Fit.p.pane.m <- mc_str

load(here("SSIPM_output", "mc_str_ar_A_pane_mitigation.RData"))
Fit.a.pane.m <- mc_str
```


# Post-processing the chains 
combine chains & do diagnostic checks

### California Sheepehad
```{r}
Post.fit.p.a.sepu<- postproc.MCMC(Fit.p.a.sepu)
Post.fit.p.sepu<- postproc.MCMC(Fit.p.sepu)
Post.fit.a.sepu<- postproc.MCMC(Fit.a.sepu)
# 
Post.fit.p.a.mitigation <- postproc.MCMC(Fit.p.a.sepu.m)
Post.fit.p.mitigation <- postproc.MCMC(Fit.p.sepu.m)
Post.fit.a.mitigation <- postproc.MCMC(Fit.a.sepu.m)

```

### Kelp Bass
```{r}
Post.fit.p.a.pacl <- postproc.MCMC(Fit.p.a.pacl)
Post.fit.p.pacl<- postproc.MCMC(Fit.p.pacl)
Post.fit.a.pacl<- postproc.MCMC(Fit.a.pacl)

Post.fit.p.a.pacl.m <- postproc.MCMC(Fit.p.a.pacl.m)
Post.fit.p.pacl.m <- postproc.MCMC(Fit.p.pacl.m)
Post.fit.a.pacl.m <- postproc.MCMC(Fit.a.pacl.m)
```

### Barred Sandbass
```{r}
Post.fit.p.a.pane <- postproc.MCMC(Fit.p.a.pane)
Post.fit.p.pane<- postproc.MCMC(Fit.p.pane)
Post.fit.a.pane<- postproc.MCMC(Fit.a.pane)

Post.fit.p.a.pane.m <- postproc.MCMC(Fit.p.a.pane.m)
Post.fit.p.pane.m <- postproc.MCMC(Fit.p.pane.m)
Post.fit.a.pane.m <- postproc.MCMC(Fit.a.pane.m)
```

# DIC model selection

### California Sheepehad
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.sepu)$DIC #6300.428, noyoy: 5824.036
ssipm.dic(postproc.MCMC = Post.fit.p.sepu)$DIC # 42128.89, noyoy: 41735.83
ssipm.dic(postproc.MCMC = Post.fit.a.sepu)$DIC #11285.53, noyoy: 7751.491

ssipm.dic(postproc.MCMC = Post.fit.p.a.mitigation)$DIC # 6199.066
ssipm.dic(postproc.MCMC = Post.fit.p.mitigation)$DIC # 11774.85
ssipm.dic(postproc.MCMC = Post.fit.a.mitigation)$DIC # 9392.491
```

### Kelp Bass
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.pacl)$DIC # 4159.849
ssipm.dic(postproc.MCMC = Post.fit.p.pacl)$DIC # 31011.92
ssipm.dic(postproc.MCMC = Post.fit.a.pacl)$DIC # 4595.92

ssipm.dic(postproc.MCMC = Post.fit.p.a.pacl.m)$DIC # 3504.267
ssipm.dic(postproc.MCMC = Post.fit.p.pacl.m)$DIC # 5107.235
ssipm.dic(postproc.MCMC = Post.fit.a.pacl.m)$DIC # 3641.209
```

### Barred Sandbass
```{r}
ssipm.dic(postproc.MCMC = Post.fit.p.a.pane)$DIC # 4330.184
ssipm.dic(postproc.MCMC = Post.fit.p.pane)$DIC # 35769.25
ssipm.dic(postproc.MCMC = Post.fit.a.pane)$DIC # 6263.839

ssipm.dic(postproc.MCMC = Post.fit.p.a.pane.m)$DIC # 3962.039
ssipm.dic(postproc.MCMC = Post.fit.p.pane.m)$DIC # 12151.83
ssipm.dic(postproc.MCMC = Post.fit.a.pane.m)$DIC # 4890.307
```


#Posterior predictive checks 
```{r}
#for ease of working, make a function for plotting the posterior predictive interval and the survey data
ppc.plot <- function(samp.dist.quart,data.ipm){
p <-   ggplot()+
  geom_pointrange(data = samp.dist.quart, mapping = aes(x = size, y =mean,ymin = lower_95, ymax = upper_95), color = "skyblue2", linewidth = 2.5)+ #95% confidence Interval
  geom_pointrange(data = samp.dist.quart, mapping = aes(x = size, y =mean,ymin = lower_50, ymax = upper_50), color = "skyblue4", linewidth = 3, alpha = 0.5)+ #50% confidence Interval
  geom_point(data = samp.dist.quart, mapping = aes(x = size, y =mean),color = "darkblue", size = 3)+
  geom_point(data.ipm %>% mutate(size = size.bin),
  mapping = aes(x = size, y = density),color = "#9A32CD", size = 4, alpha = 0.5)+
  theme_bw()+
    # xlab("Size (cm)")+
  theme(
        axis.text.x = element_text(
          # angle = 270, vjust = 0.5, hjust=1,
                                   size = 15),
        axis.text.y = element_text(size = 17))
return(p)
}
```


```{r}
#best California sheephead model
sepu.ppc.bins <- c("9 - 19","20 - 29","30 - 40","41 - 50","52 - 61","62 - 71","72 - 82","83 - 92","93 - 103","104 - 114")

# Experimental Reefs
sepu <- post.pred.check(Data = fishtotal.sepu,fix.param = fix.param.sepu, Post.fit = Post.fit.p.a.sepu, ipm.burnin = FALSE)
#year 21 - 2020
sepu2020 <- ppc.plot(sepu$pp.interval.year21,sepu$data.year21)+labs(title = "a) California Sheephead experimental reef 2020")+scale_x_discrete(labels = sepu.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 22 - 2021
sepu2021 <-ppc.plot(sepu$pp.interval.year22,sepu$data.year22)+labs(title = "b) California Sheephead experimental reef 2021")+scale_x_discrete(labels = sepu.ppc.bins)+
  labs(y = "Density")+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(size = 15),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 23 - 2022
sepu2022 <-ppc.plot(sepu$pp.interval.year23,sepu$data.year23)+labs(title = "c) California Sheephead experimental reef 2022")+scale_x_discrete(labels = sepu.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))


## Mitigation Reef
sepu.m <- post.pred.check(Data = fishtotal.m.sepu,fix.param = fix.param.m.sepu, Post.fit = Post.fit.p.a.mitigation, ipm.burnin = FALSE)
#year 12 - 2020
sepu2020.m <- ppc.plot(sepu.m$pp.interval.year12,sepu.m$data.year12)+labs(title = "d) California Sheephead mitigation reef 2020")+scale_x_discrete(labels = sepu.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 13 - 2021
sepu2021.m <- ppc.plot(sepu.m$pp.interval.year13,sepu.m$data.year13)+labs(title = "e) California Sheephead mitigation reef 2021")+scale_x_discrete(labels = sepu.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 14 - 2022
sepu2022.m <- ppc.plot(sepu.m$pp.interval.year14,sepu.m$data.year14)+labs(title = "f) California Sheephead mitigation reef 2022")+scale_x_discrete(labels = sepu.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))

(sepu2020+sepu2020.m)/(sepu2021+sepu2021.m)/(sepu2022+sepu2022.m+
  plot_layout(axis_titles = "collect"))
# ggsave("post.pred.p.a.sepu.pdf", width = 11, height = 10,units = "in",path = here("SSIPM_output","plots"))
```


```{r}
#best Kelp bass model
pacl.ppc.bins <- c("9 - 22","23 - 35","36 - 48","49 - 61","62 - 74","75 - 87", "88 - 100","101 - 113", "114 - 126", "127 - 140")

#exoerimental reef
pacl <- post.pred.check(Data = fishtotal.pacl,fix.param = fix.param.pacl, Post.fit = Post.fit.p.a.pacl, ipm.burnin = FALSE)
#year 21 - 2020
pacl2020 <- ppc.plot(pacl$pp.interval.year21,pacl$data.year21)+labs(title = "a) Kelp Bass experimental reef 2020")+scale_x_discrete(labels = pacl.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 22 - 2021
pacl2021 <-ppc.plot(pacl$pp.interval.year22,pacl$data.year22)+labs(title = "b) Kelp Bass experimental reef 2021")+scale_x_discrete(labels = pacl.ppc.bins)+
  labs(y = "Density")+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(size = 15),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 23 - 2022
pacl2022 <-ppc.plot(pacl$pp.interval.year23,pacl$data.year23)+labs(title = "c) Kelp Bass experimental reef 2022")+scale_x_discrete(labels = pacl.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))


#mitigation reef 
pacl.m <- post.pred.check(Data = fishtotal.m.pacl, fix.param = fix.param.m.pacl, Post.fit = Post.fit.p.a.pacl.m, ipm.burnin = FALSE)

#year 12 - 2020
pacl2020.m <- ppc.plot(pacl.m$pp.interval.year12,pacl.m$data.year12)+labs(title = "d) Kelp Bass mitigation reef 2020")+scale_x_discrete(labels = pacl.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 13 - 2021
pacl2021.m <- ppc.plot(pacl.m$pp.interval.year13,pacl.m$data.year13)+labs(title = "e) Kelp Bass mitigation reef 2021")+scale_x_discrete(labels = pacl.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 14 - 2022
pacl2022.m <- ppc.plot(pacl.m$pp.interval.year14,pacl.m$data.year14)+labs(title = "f) Kelp Bass mitigation reef 2022")+scale_x_discrete(labels = pacl.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))

(pacl2020+pacl2020.m)/(pacl2021+pacl2021.m)/(pacl2022+pacl2022.m+
  plot_layout(axis_titles = "collect"))
# ggsave("post.pred.p.a.pacl.pdf", width = 11, height = 10,units = "in",path = here("SSIPM_output","plots"))
```

```{r}
pane.ppc.bins <- c("9 - 20", "21 - 31","32 - 42", "43 - 54","55 - 65", "66 - 76", "77 - 88", "89 - 99", "100 - 110", "111 - 122")

pane <- post.pred.check(Data = fishtotal.pane,fix.param = fix.param.pane, Post.fit = Post.fit.p.a.pane, ipm.burnin = FALSE)
#year 21 - 2020
pane2020 <- ppc.plot(pane$pp.interval.year21,pane$data.year21)+labs(title = "a) Barred Sand Bass experimental reef 2020")+scale_x_discrete(labels = pane.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 22 - 2021
pane2021 <-ppc.plot(pane$pp.interval.year22,pane$data.year22)+labs(title = "b) Barred Sand Bass experimental reef 2021")+scale_x_discrete(labels = pane.ppc.bins)+
  labs(y = "Density")+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(size = 15),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 23 - 2022
pane2022 <-ppc.plot(pane$pp.interval.year23,pane$data.year23)+labs(title = "c) Barred Sand Bass experimental reef 2022")+scale_x_discrete(labels = pane.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))

pane.m <- post.pred.check(Data = fishtotal.m.pane,fix.param = fix.param.m.pane, Post.fit = Post.fit.p.a.pane.m, ipm.burnin = FALSE)

#year 12 - 2020
pane2020.m <- ppc.plot(pane.m$pp.interval.year12,pane.m$data.year12)+labs(title = "d) Barred Sand Bass mitigation reef 2020")+scale_x_discrete(labels = pane.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 13 - 2021
pane2021.m <- ppc.plot(pane.m$pp.interval.year13,pane.m$data.year13)+labs(title = "e) Barred Sand Bass mitigation reef 2021")+scale_x_discrete(labels = pane.ppc.bins)+
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))
#year 14 - 2022
pane2022.m <- ppc.plot(pane.m$pp.interval.year14,pane.m$data.year14)+labs(title = "f) Barred Sand Bass mitigation reef 2022")+scale_x_discrete(labels = pane.ppc.bins)+
  xlab("Length (cm)")+
theme(axis.text.x = element_text(size = 13, angle = 45,hjust = 1),
      axis.title.x = element_text(size = 15),axis.title.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 15))

(pane2020+pane2020.m)/(pane2021+pane2021.m)/(pane2022+pane2022.m+
  plot_layout(axis_titles = "collect"))
# ggsave("post.pred.p.a.pane.pdf", width = 11, height = 10,units = "in",path = here("SSIPM_output","plots"))

```


# Plot results

Plot results and save to folder

Build functions to streamline plotmaking
```{r}
# Examine the prior historgram and trace plot
trace.plot <- function(post.fit,ggtitle){ggplot()+
  geom_line(data = data.frame(post.fit), aes(y = post.fit$PosteriorProb, x = c(1:length(post.fit$PosteriorProb))), color = "black")+
  xlim(0, length(post.fit$PosteriorProb))+
  ylim(min(post.fit$PosteriorProb),max(post.fit$PosteriorProb))+ggtitle(ggtitle)+
    theme(axis.title.x = element_blank())} #make trace plot using probability estimations

posterior.plot <- function(data,post.fit,model,ggtitle){
  test <- data.frame(post.fit$Values) %>%
  pivot_longer(cols = 1:(ncol(post.fit$Values)-2), # get only recruit and immigration variables
                names_to = "var",
                values_to = "posterior") %>%
  mutate(var = as.factor(var)) %>%
  mutate(var = fct_relevel(var, c(paste0("r",c(1:(dim(data)[2]))), paste0("i",c(1:(dim(data)[2]))), 'F', "nb.k")))
  
  if(model == "PA"){
p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  # filter(variable == "Immigrant") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior *10000, x = year , color = variable, fill = variable), alpha = 0.5)+ #transform from per m2 to hectare
  labs(y = "individals per hectare")+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  # scale_fill_manual(values = c( "#F8766D","#00BFC4"))+
  # scale_color_manual(values = c("#F8766D","#00BFC4"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10')+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 20),strip.text = element_text(size = 20),
          axis.title = element_text(size = 20))
  }
  if(model == "P"){p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  filter(variable == "Recruit") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior, x = year , color = variable, fill = variable), alpha = 0.5)+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  scale_fill_manual(values = c( "#00BFC4"))+
  scale_color_manual(values = c("#00BFC4"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10', labels = scales::label_comma())+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 15),strip.text = element_text(size = 15),axis.title.y = element_blank())}
  if(model == "A"){
p <-   data.frame(str_split_fixed(test$var,pattern = '', n = 2)) %>%  #split names to individual components
    rename(variable = "X1",year = "X2") %>% # re-compose variable names from individual components
    dplyr::select(variable, year) %>% 
    bind_cols(test,.) %>%  #bind the two
    filter(variable %in% c('r', 'i')) %>% 
  mutate(variable = case_when(variable == "r" ~ "Recruit",variable == "i" ~ "Immigrant")) %>% 
    mutate(year = as.factor(year),
           variable = as.factor(variable)) %>% 
  filter(variable == "Immigrant") %>% # Use only one if testing just recruitment vs just immigration
    mutate(year = fct_relevel(year, paste(c(1:23)))) %>%
  ggplot( )+
  geom_violin(aes( y = posterior, x = year , color = variable, fill = variable), alpha = 0.5)+
  # facet_grid(rows = vars(variable), scales = "free_y")+
  scale_fill_manual(values = c( "#F8766D"))+
  scale_color_manual(values = c("#F8766D"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(trans = 'log10')+
  # coord_trans(y ='log10')+
    # geom_vline(xintercept = c(9.5,20.5), color = "red")+
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.text = element_text(size = 20),strip.text = element_text(size = 20),axis.title.y = element_blank())
  }

#add shade to heatwave
# p + annotate("rect", xmin = 14.5,xmax = 17.5,ymin = -Inf, ymax = Inf, fill = "red", alpha = 0.2)+ #add box around blob
# geom_text()

f <- data.frame(test %>% select("F","nb.k")) %>% 
  pivot_longer(cols = c("F","nb.k"),names_to = "var",values_to = "posterior") %>% 
  ggplot(aes(x = var, y = posterior))+
  geom_violin( fill = "lavender")+
  facet_wrap(~var, scales = "free")+
  theme_bw()+
  theme(axis.title.x = element_blank(),axis.text = element_text(size = 20),strip.text = element_text(size = 20),axis.title = element_text(size = 20),
        strip.text.x = element_blank())
  # stat_summary(fun = "median",
  #              geom = "text")

(f+p+plot_layout(widths = c(3, 15)))+ggtitle(ggtitle)
}

y = as.character(c(2000:2022)) #column titles for years
y.m = as.character(c(2009:2022)) #column titles for mitigation years

first.years = as.character(c(2000:2003))
first.years.m = as.character(c(2009:2012))
density.plot <- function(data,post.fit,fix.param, transect, year_name,ipm.i, ipm.r, ggtitle ){
  
t.sect <- data.frame( t(transect)) %>%
  mutate(year = as.character(rownames(.)))

# #### Survey density
tfish <- data %>% add_column(size = c(1:nrow(data))) %>%
  pivot_longer(cols = c(1:length(data)), names_to = "year",values_to = "count") %>%
  left_join(., t.sect) %>%
  mutate(density = count/t.transect.)

#size distribution from ipm using median values
median <- c(unname( sapply(data.frame(post.fit$Values), median)))
names(median) <- colnames(post.fit$Values)

ipm.plot <- run.IPM(fix.param = fix.param, cand.param = median, Data =  data, burnin = FALSE, ipm.i = ipm.i,ipm.r = ipm.r)

sizedist <- data.frame(ipm.plot$N)

tipm <- sizedist %>% select(c(1:ncol(sizedist))) %>% #IPM with data fitting
  rename_all(~year_name) %>%  #rename columns to match year
  add_column(size = c(1:nrow(sizedist))) %>% #add sizes
  mutate(size = size*fix.param$dx) %>%
  pivot_longer(cols = 1:ncol(sizedist),
               names_to = "year",
               values_to = "N") %>%
  group_by(year)

plot <- ggplot()+
  geom_line(data = tfish, aes(x = size, y = density*10000), color = "black", linewidth = 0.4) +
  geom_line(data = tipm, aes(x = size, y = N*10000), color = "red")+
  facet_wrap(~year, scales = "free_y", ncol = 4) +
  # facet_grid(vars(year), scales = "free_y")
  scale_y_continuous("Individual per hectare", labels = scales::label_comma()) +
    theme_bw()+
  lims(x = c(0,80))+
  labs(x = "Length (cm)")+
  ggtitle(ggtitle)+
  theme(legend.position = "none",
        axis.text = element_text(size = 20),
        strip.text = element_text(size = 20),
        title = element_text(size = 20))

return(plot)
}


density.plot.fist.years <- function(data,post.fit,fix.param, transect, year_name, first.years, ipm.i, ipm.r, ggtitle ){
  
  #gather survey area per year 
t.sect <- data.frame( t(transect)) %>%
  mutate(year = as.character(rownames(.)))

# #### Survey density
tfish <- data %>% add_column(size = c(1:nrow(data))) %>%
  pivot_longer(cols = c(1:length(data)), names_to = "year",values_to = "count") %>%
  left_join(., t.sect) %>%
  mutate(density = count/t.transect.) %>% 
  filter(year %in% first.years) # filter for the first few years

#size distribution from ipm using median values
median <- c(unname( sapply(data.frame(post.fit$Values), median)))
names(median) <- colnames(post.fit$Values)

ipm.plot <- run.IPM(fix.param = fix.param, cand.param = median, Data =  data, burnin = FALSE, ipm.i = ipm.i,ipm.r = ipm.r)

sizedist <- data.frame(ipm.plot$N)

tipm <- sizedist %>% select(c(1:ncol(sizedist))) %>% #IPM with data fitting
  rename_all(~year_name) %>%  #rename columns to match year
  add_column(size = c(1:nrow(sizedist))) %>% #add sizes
  mutate(size = size*fix.param$dx) %>%
  pivot_longer(cols = 1:ncol(sizedist),
               names_to = "year",
               values_to = "N") %>%
  group_by(year)%>% 
  filter(year %in% first.years)# filter for the first few years

plot <- ggplot()+
  geom_line(data = tfish, aes(x = size, y = density*10000), color = "black", linewidth = 0.4) +
  geom_line(data = tipm, aes(x = size, y = N*10000), color = "red")+
  facet_wrap(~year, scales = "free_y", ncol = 4) +
  # facet_grid(vars(year), scales = "free_y")
  scale_y_continuous("Individual per hectare", labels = label_number(accuracy = 1)) +
    theme_bw()+
  lims(x = c(0,80))+
  labs(x = "Length (cm)")+
  ggtitle(ggtitle)+
  theme(legend.position = "none",
        axis.text = element_text(size = 20),
        strip.text = element_text(size = 20),
        title = element_text(size = 20))

return(plot)
}

```

### California Sheephead
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.sepu, "p.a.sepu")
# ggsave("trace.p.a.sepu_noyoy.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.sepu,"a.sepu")
# ggsave("trace.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.sepu,"p.sepu")
# ggsave("trace.p.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

#mitigation reef
trace.plot(Post.fit.p.a.mitigation, "p.a.sepu.m")
# ggsave("trace.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.mitigation,"a.sepu.m")
# ggsave("trace.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.mitigation,"p.sepu.m")
# ggsave("trace.p.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.sepu, Post.fit.p.a.sepu, model = "PA", ggtitle = "p.a.sepu")
# ggsave("posterior.p.a.sepu.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))


posterior.plot(fishtotal.m.sepu, Post.fit.p.a.mitigation, model = "PA", ggtitle = "p.a.sepu.m")
# ggsave("posterior.p.a.sepu.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
# posterior.plot(fishtotal.m.sepu, Post.fit.a.mitigation, model = "A", ggtitle = "a.sepu.m")

#experimental reef
density.plot(data = fishtotal.sepu, post.fit = Post.fit.p.a.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.sepu")
# ggsave("density.p.a.sepu.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))


density.plot(data = fishtotal.sepu, post.fit = Post.fit.p.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.sepu")
# ggsave("density.p.sepu.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.sepu, post.fit = Post.fit.a.sepu, fix.param = fix.param.sepu, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.sepu")
# ggsave("density.a.sepu.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))


#first 4 years
sepu.p.a.firstyears <- density.plot.fist.years(data = fishtotal.sepu, post.fit = Post.fit.p.a.sepu, fix.param = fix.param.sepu, first.years = first.years, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "Production & Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

sepu.a.firstyears <- density.plot.fist.years(data = fishtotal.sepu, post.fit = Post.fit.a.sepu, fix.param = fix.param.sepu, first.years = first.years, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

sepu.p.firstyears <- density.plot.fist.years(data = fishtotal.sepu, post.fit = Post.fit.p.sepu, fix.param = fix.param.sepu, first.years = first.years, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

sepu.p.a.firstyears/sepu.a.firstyears/sepu.p.firstyears+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.sepu.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

##### mitigation reef
density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.p.a.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.sepu.m")
# ggsave("density.p.a.sepu.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.p.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.sepu.m")
# ggsave("density.p.sepu.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.sepu, post.fit = Post.fit.a.mitigation, fix.param = fix.param.m.sepu, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.sepu.m")
# ggsave("density.a.sepu.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))


#first four 
#first 4 years
sepu.p.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.sepu, post.fit = Post.fit.p.a.mitigation, fix.param = fix.param.m.sepu, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "Attraction & Production")+
  theme(axis.text.x = element_blank())

sepu.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.sepu, post.fit = Post.fit.a.mitigation, fix.param = fix.param.m.sepu, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank())

sepu.p.firstyears.m <- density.plot.fist.years(data = fishtotal.m.sepu, post.fit = Post.fit.p.mitigation, fix.param = fix.param.m.sepu, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

sepu.p.a.firstyears.m/sepu.a.firstyears.m/sepu.p.firstyears.m+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.sepu.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

```

### Kelp Bass
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.pacl, "p.a.pacl")
# ggsave("trace.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.pacl,"a.pacl")
# ggsave("trace.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.pacl,"p.pacl")
# ggsave("trace.p.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

trace.plot(Post.fit.p.a.pacl.m, "p.a.pacl.m")
# ggsave("trace.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.pacl.m,"a.pacl.m")
# ggsave("trace.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.pacl.m,"p.pacl.m")
# ggsave("trace.p.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.pacl, Post.fit.p.a.pacl, model = "PA", ggtitle = "p.a.pacl")
# ggsave("posterior.p.a.pacl.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

posterior.plot(fishtotal.m.pacl, Post.fit.p.a.pacl.m, model = "PA", ggtitle = "p.a.pacl.m")
# ggsave("posterior.p.a.pacl.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

#density plot - experimental reef
density.plot(data = fishtotal.pacl, post.fit = Post.fit.p.a.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pacl")
# ggsave("density.p.a.pacl.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.pacl, post.fit = Post.fit.p.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pacl")
# ggsave("density.p.pacl.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.pacl, post.fit = Post.fit.a.pacl, fix.param = fix.param.pacl, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pacl")
# ggsave("density.a.pacl.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))


# first four years
pacl.p.a.firstyears <- density.plot.fist.years(data = fishtotal.pacl, post.fit = Post.fit.p.a.pacl, fix.param = fix.param.pacl, first.years = first.years, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE, ggtitle = "Production & Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pacl.a.firstyears <- density.plot.fist.years(data = fishtotal.pacl, post.fit = Post.fit.a.pacl, fix.param = fix.param.pacl, first.years = first.years, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pacl.p.firstyears <- density.plot.fist.years(data = fishtotal.pacl, post.fit = Post.fit.p.pacl, fix.param = fix.param.pacl, first.years = first.years, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

pacl.p.a.firstyears/pacl.a.firstyears/pacl.p.firstyears+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.pacl.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))


###### mitigation reef
density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.p.a.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pacl.m")
# ggsave("density.p.a.pacl.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.p.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pacl.m")
# ggsave("density.p.pacl.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.pacl, post.fit = Post.fit.a.pacl.m, fix.param = fix.param.m.pacl, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pacl.m")
# ggsave("density.a.pacl.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))


# first four years
pacl.p.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pacl, post.fit = Post.fit.p.a.pacl.m, fix.param = fix.param.m.pacl, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE, ggtitle = "Production & Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pacl.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pacl, post.fit = Post.fit.a.pacl.m, fix.param = fix.param.m.pacl, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pacl.p.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pacl, post.fit = Post.fit.p.pacl.m, fix.param = fix.param.m.pacl, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

pacl.p.a.firstyears.m/pacl.a.firstyears.m/pacl.p.firstyears.m+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.pacl.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))
```

### Barred Sandbass
```{r}
# experimental reef & save
trace.plot(Post.fit.p.a.pane, "p.a.pane")
# ggsave("trace.p.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.pane,"a.pane")
# ggsave("trace.a.pane.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.pane,"p.pane")
# ggsave("trace.p.pane.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

trace.plot(Post.fit.p.a.pane.m, "p.a.pane.m")
# ggsave("trace.p.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.a.pane.m,"a.pane.m")
# ggsave("trace.a.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))
trace.plot(Post.fit.p.pane.m,"p.pane.m")
# ggsave("trace.p.pane.m.pdf", width = 11, height = 8.5,units = "in",path = here("SSIPM_output","plots"))

# Posterior Plot - Best model
posterior.plot(fishtotal.pane, Post.fit.p.a.pane, model = "PA", ggtitle = "p.a.pane")
# ggsave("posterior.p.a.pane.pdf", width = 11, height = 9,units = "in",path = here("SSIPM_output","plots"))

posterior.plot(fishtotal.m.pane, Post.fit.p.a.pane.m, model = "PA", ggtitle = "p.a.pane.m")
# ggsave("posterior.p.a.pane.m.pdf", width = 11, height = 9,units = "in",path = here("SSIPM_output","plots"))

#density plot - experimental reef
density.plot(data = fishtotal.pane, post.fit = Post.fit.p.a.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pane")
# ggsave("density.p.a.pane.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.pane, post.fit = Post.fit.p.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pane")
# ggsave("density.p.pane.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.pane, post.fit = Post.fit.a.pane, fix.param = fix.param.pane, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pane")
# ggsave("density.a.pane.pdf", width = 14, height = 14,units = "in",path = here("SSIPM_output","plots"))

#first four years
pane.p.a.firstyears <- density.plot.fist.years(data = fishtotal.pane, post.fit = Post.fit.p.a.pane, fix.param = fix.param.pane, first.years = first.years, transect = transect, year_name = y, ipm.i = TRUE, ipm.r =TRUE, ggtitle = "Production & Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pane.a.firstyears <- density.plot.fist.years(data = fishtotal.pane, post.fit = Post.fit.a.pane, fix.param = fix.param.pane, transect = transect, first.years = first.years, year_name = y, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pane.p.firstyears <- density.plot.fist.years(data = fishtotal.pane, post.fit = Post.fit.p.pane, fix.param = fix.param.pane, first.years = first.years, transect = transect, year_name = y, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

pane.p.a.firstyears/pane.a.firstyears/pane.p.firstyears+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.pane.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

#mitigation reef
density.plot(data = fishtotal.m.pane, post.fit = Post.fit.p.a.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE,ggtitle = "p.a.pane.m")
# ggsave("density.p.a.pane.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.pane, post.fit = Post.fit.p.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE,ggtitle = "p.pane.m")
# ggsave("density.p.pane.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

density.plot(data = fishtotal.m.pane, post.fit = Post.fit.a.pane.m, fix.param = fix.param.m.pane, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE,ggtitle = "a.pane.m")
# ggsave("density.a.pane.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

#first four years
# first four years
pane.p.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pane, post.fit = Post.fit.p.a.pane.m, fix.param = fix.param.m.pane, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =TRUE, ggtitle = "Production & Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pane.a.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pane, post.fit = Post.fit.a.pane.m, fix.param = fix.param.m.pane, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = TRUE, ipm.r =FALSE, ggtitle = "Attraction")+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

pane.p.firstyears.m <- density.plot.fist.years(data = fishtotal.m.pane, post.fit = Post.fit.p.pane.m, fix.param = fix.param.m.pane, first.years = first.years.m, transect = transect_mitigation, year_name = y.m, ipm.i = FALSE, ipm.r =TRUE, ggtitle = "Production")

pane.p.a.firstyears.m/pane.a.firstyears.m/pane.p.firstyears.m+plot_layout(axis_titles = "collect")
# ggsave("density.first.four.p.a.pane.m.pdf", width = 14, height = 11,units = "in",path = here("SSIPM_output","plots"))

```



## Summary of posteriors (individuals per hectare)
```{r}
#immigration 
summary(c(sapply(data.frame(Post.fit.p.a.pane$Values[,c(24:46)])*10000, median)))
summary(c(sapply(data.frame(Post.fit.p.a.pane.m$Values[,c(15:28)])*10000, median)))

#Recruitment
summary(c(sapply(data.frame(Post.fit.p.a.pane$Values[,c(1:23)])*10000, median)))
summary(c(sapply(data.frame(Post.fit.p.a.pane.m$Values[,c(1:14)])*10000, median)))

#Fishing mortality
median(Post.fit.p.a.pane$Values[,47]) 
median(Post.fit.p.a.pane.m$Values[,29])

#Dispersion
median(Post.fit.p.a.pane$Values[,48]) 
median(Post.fit.p.a.pane.m$Values[,30])
```

## Estimate of number of fish that move/recruit per year (not as density)
### California Sheephead
```{r}
#immigrant
im.fish.sepu <-  data.frame(cbind(matrix(sapply(data.frame(Post.fit.p.a.sepu$Values[,c(24:46)]), median)),matrix(transect))) %>% mutate("individual" = X1*X2)
mean(im.fish$individual[c(1:7,10:23)])

#recruit
r.fish.sepu <- data.frame(cbind(matrix(sapply(data.frame(Post.fit.p.a.sepu$Values[,c(1:23)]), median)),matrix(transect))) %>% mutate("individual" = X1*X2)
mean(r.fish$individual[c(1:7,10:23)])


## Mitigation reef
#immigrant
im.fish.sepu.m <-  data.frame(cbind(matrix(sapply(data.frame(Post.fit.p.a.mitigation$Values[,c(15:28)]), median)),matrix(transect_mitigation))) %>% mutate("individual" = X1*X2)
mean(im.fish$individual)

#recruit
r.fish.sepu.m <- data.frame(cbind(matrix(sapply(data.frame(Post.fit.p.a.mitigation$Values[,c(1:14)]), median)),matrix(transect_mitigation))) %>% mutate("individual" = X1*X2)
mean(r.fish$individual)

```

### Kelp Bass
```{r}

```

### Barred Sand Bass
```{r}

```


## Plots

#### Immigrant size-dependent function
```{r}
# add descriptive info for each species 
im.size.fun.sepu <- data.frame( "prob" = I.size.fun.sepu) %>% mutate("size" = c(1:length(I.size.fun.sepu)), "species" = "California Sheephead") 

im.size.fun.pacl <- data.frame( "prob" = I.size.fun.pacl) %>% mutate("size" = c(1:length(I.size.fun.pacl)), "species" = "Kelp Bass") 

im.size.fun.pane <- data.frame( "prob" = I.size.fun.pane) %>% mutate("size" = c(1:length(I.size.fun.pane)), "species" = "Barred Sand Bass") 

#combine all species for plotting
im.size.fun <- bind_rows(im.size.fun.sepu,im.size.fun.pacl, im.size.fun.pane) %>% 
  mutate(species = fct_relevel(species, c("California Sheephead", "Kelp Bass","Barred Sand Bass" )))

#plot
im.size.fun %>% 
  ggplot()+
  geom_point(aes(x = size, y = prob)) +
  facet_wrap(~species, scale ="free_x")+
  theme_bw()+
  theme(axis.text = element_text(size = 15),strip.text = element_text(size = 20),axis.title = element_text(size = 20), panel.spacing = unit(0.5, "lines"), plot.margin = margin(r =10))+
  scale_x_continuous(breaks = seq(0,max(im.size.fun$size), by = 25))+
  labs(y = "Probability", x = "Total Length (cm)")
ggsave("size_dep_immigration_function.pdf", width = 11, height = 8.7,units = "in",path = here("SSIPM_output","plots"))

```


### Fishing posterior
```{r}
Post.fit.p.a.sepu$Values[,47]
Post.fit.p.a.mitigation$Values[,29]

#make datafram of posterior
fishing.mort.posterior <- data.frame(sepu = Post.fit.p.a.sepu$Values[,47],
           sepu.m = Post.fit.p.a.mitigation$Values[,29],
           pacl = Post.fit.p.a.pacl$Values[,47],
           pacl.m = Post.fit.p.a.pacl.m$Values[,29],
           pane = Post.fit.p.a.pane$Values[,47],
           pane.m = Post.fit.p.a.pane.m$Values[,29]
           ) %>% 
  pivot_longer(cols = c(1:6), names_to = "species_code",values_to = "posterior") %>% 
  mutate(species_code = as.factor(species_code)) %>% 
   mutate( "reef" = dplyr::case_match(species_code, c("sepu","pacl","pane" ) ~ "Experimental",
                              c("sepu.m","pacl.m","pane.m") ~ "Mitigation"))

#make dataframe of prior
fishing.mort.prior <- data.frame("species_code" = c("sepu","sepu.m","pacl","pacl.m","pane","pane.m"),
                                 prior = c(rep(0.22,2),rep(0.12,2),rep(0.10,2)))%>% 
   mutate( "reef" = dplyr::case_match(species_code, c("sepu","pacl","pane" ) ~ "Experimental",
                              c("sepu.m","pacl.m","pane.m") ~ "Mitigation"))


#plot
ggplot()+
  geom_violin(fishing.mort.posterior %>% mutate(species_code = factor(species_code, levels=c("sepu","sepu.m","pacl","pacl.m","pane","pane.m")),
                                                reef = factor(reef, levels=c("Experimental", "Mitigation"))),  #refactor species
              # filter(!species_code %in% c("sepu","sepu.m")), #only sepu
 mapping = aes(x = species_code, y = posterior,fill = reef))+
  
  geom_point(fishing.mort.prior%>% mutate(species_code = factor(species_code, levels=c("sepu","sepu.m","pacl","pacl.m","pane","pane.m")),
 reef = factor(reef, levels=c("Experimental", "Mitigation"))),  #refactor species 
 # filter(!species_code == c("sepu","sepu.m")), #only sepu
 mapping = aes(x = species_code, y = prior, color = "black"), size = 4
 )+ 
  # scale_y_continuous(limits = c(0.05, 0.95), breaks = seq(0.05,0.95,0.1))+
  # scale_x_discrete( labels = c("Experimental", "Mitigation","Experimental","Mitigation","Experimental","Mitigation"))+
  theme_bw()+
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 20),
        axis.text.x = element_text(),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))+
  ylab( expression(paste("Fishing Mortality", " (yr"^'-1',")")))+
  labs(fill = "Reef")+
  scale_fill_manual(values = c("#E6B9D9", "#926590"))+
  scale_color_manual(name = "Prior", values = "black",label = "Regional
Estimate")
    # scale_fill_manual(name = "Species",values = c("#C9C75E","#65A856","#257740"))
  # theme(legend.position = "none")

```


### Transect trend
```{r}
songs %>% 
  filter(phase_built_code %in% c("E", "M", "NA"),
         transtype_strata %in% c("BOTTOM",NA),
         species_code == "SEPU") %>%
  pivot_wider(names_from = total_length, values_from = count) %>% mutate(count = 1) %>% summarise(transect = sum(count), .by = c(year,reef_code,phase_built_code)) %>% ggplot()+
  geom_col(aes(x = year, y = transect, fill = phase_built_code), position = position_dodge(), color = "gray22", width = 0.8)+
  scale_fill_viridis_d()+
  # facet_wrap(~phase_built_code)+
  labs(fill = "Reef", y = "Transect (n)")+
  theme_bw()
  # scale_fill_manual(labels = c("Experimental","Mitigation"), values = c("blue","red"))
```

### Number of fish observed
```{r}
# # relabel site 
site_names <- c("E" = "Experimental Reef",
                "M" = "Mitigation Reef",
                "N" = "Natural Reef")
#add label
tag.count <- data.frame(phase_built_code = c("E","M"), tag = c("a)","b)"))%>% mutate( phase_built_code = fct_relevel(phase_built_code, c("E","M")))

songs %>% 
  filter(phase_built_code %in% c("E", "M", "NA"),
         transtype_strata %in% c("BOTTOM",NA),
         species_code %in% c("SEPU","PACL","PANE")) %>%
  uncount(count) %>% 
  mutate(n = 1) %>% 
  summarise(count = sum(n), .by = c(year,phase_built_code, species_code)) %>% 
  ggplot()+
  geom_point(aes(x = year, y = count, group = species_code, color = species_code), size = 2)+
  geom_line(aes(x = year, y = count, group = species_code, color = species_code), size = 2, alpha = 0.5)+
  geom_text(data = tag.count, aes(x = 2001, y = 820, label = tag),size = 10, fontface = "bold")+
  # geom_col(aes(x = year, y = count, group = species_code, fill = species_code), position = position_dodge(), color = "gray50", width = 1)+
  facet_wrap(~phase_built_code, labeller = as_labeller(site_names))+
  # scale_color_viridis_d()+
  scale_color_brewer(palette = "Dark2",labels = c("Kelp Bass", "Barred Sand Bass", "California Sheephead"))+
  # scale_color_grey(start = 0, end = 0.7)+
  geom_hline(yintercept = 100, linetype = "dashed")+
  labs(color = "Species", y = "Count")+
  theme_bw()+
  theme(axis.text.x = element_text( size = 12), axis.text.y = element_text(size = 10), strip.text.x = element_text(size =12),
        axis.title.x = element_text(size = 12),
        legend.title = element_text(size=12),legend.text = element_text(size=11), axis.title.y = element_text(size = 12))
```

### fish density per year (juvenile & Adults only)
```{r}
transect.smk <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA)) %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'SMK') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")%>% # make longer data frame
  pivot_longer(cols = c(1:23), names_to = "year", values_to = "area_surveyed") %>% 
  mutate(year = as.factor(year),
         "reef_code" ='SMK')


transect.wnr <- songs %>% 
  filter(species_code == "SEPU") %>% 
  filter(transtype_strata %in% c("BOTTOM",NA)) %>% #Using Bottom survey and Phase 1 reef
  drop_na(transect_code,total_length) %>% 
  pivot_wider(names_from = total_length,
              values_from = count) %>% 
  summarise(tot_transect = length(transect_code),
            .by = c(year, reef_code, total_area_sampled)) %>% 
  filter(reef_code %in% 'WNR') %>%  #Use only data from one site
  mutate(tot_area = total_area_sampled*tot_transect) %>% 
  summarise(tot_area = sum(tot_area),
            .by = c(year,reef_code)) %>% 
  select(c(year,tot_area)) %>% 
  pivot_wider(names_from = year,
              values_from = tot_area) %>% 
  add_column("2008" = NA, "2007" = NA) %>%
  relocate(c("2007","2008"), .after = "2006")%>%  #make longer data frame
  pivot_longer(cols = c(1:23), names_to = "year", values_to = "area_surveyed") %>% 
  mutate(year = as.factor(year),
         "reef_code" ='WNR')


transect.reefs <- bind_rows(transect.wnr,transect.smk) %>% mutate(reef_code = as.factor(reef_code))

# fish density of non-recruits
im.fish.data <- songs %>%
  filter( species_code %in% c("SEPU","PACL","PANE"),
          reef_code %in% c("SMK",'WNR'),
         transtype_strata %in% c("BOTTOM",NA),
         phase_built_code%in% c("N","E","M")) %>%
  summarise(tot_count = sum(count), .by = c(year, date, reef_code, species_code, transect_code,  phase_built_code,total_length)) %>% 
  drop_na(total_length) %>%
  pivot_wider(names_from = year, values_from = tot_count) %>%
  # replace(is.na(.),0) %>%
  pivot_longer(cols = c('2000':'2022'),
               names_to = "year",values_to = "count") %>% 
  mutate(year = as.factor(year)) %>%
  # left_join(.,transect.reefs) %>%
  filter(total_length>8)  # Only juvenile and adult fishes
  # summarise(sum = sum(count), .by = c(year,reef_code,species_code, transect_code,phase_built_code,area_surveyed)) %>% #summarize fish count w/ total area surveyed
  # mutate(density = sum/area_surveyed)

# sampled area by transect x year
im.transect.data <- songs %>% #
  filter( species_code %in% c("SEPU","PACL","PANE"),
          reef_code %in% c("SMK",'WNR'),
         transtype_strata %in% c("BOTTOM",NA),
         phase_built_code%in% c("N","E","M"))%>%
  summarise("annual_area_survey" = sum(total_area_sampled), .by = c(year, date, reef_code, species_code, transect_code,  phase_built_code, total_length )) %>% 
  mutate(year = as.factor(year))

im.data <- left_join(im.fish.data, im.transect.data) %>%  #merge transect and fish data
  summarise(sum = sum(count), .by = c(year, date, reef_code, species_code, transect_code,  phase_built_code, annual_area_survey )) %>%
  mutate(density = sum/annual_area_survey) %>% #estimate density per transect
  drop_na(density) %>% 
  summarise(average = mean(density), sd = sd(density), n = length(transect_code),
              .by = c(year,reef_code,species_code,phase_built_code)) %>% 
  mutate(se = sd/sqrt(n)) %>% 
  mutate(up_cl = average+se, low_cl = average-se)



# # relabel site 
site_names <- c("E" = "Experimental Reef",
                "M" = "Mitigation Reef",
                "N" = "Natural Reef")
#add plot labels
tag <- data.frame(phase_built_code = c("N","E","M"), tag = c("a)","b)","c)"))%>% mutate( phase_built_code = fct_relevel(phase_built_code, c("N","E","M")))

#actual values 
im.data %>% 
  mutate(year = as.character(year)) %>% 
  mutate(year = as.numeric(year),
         phase_built_code = fct_relevel(phase_built_code, c("N","E","M"))) %>% 
  filter(!(phase_built_code == "M" & year <2008)) %>% #remove points 
  
ggplot() + 
  geom_vline(xintercept = c(1999,2008,2020), linetype = "dashed")+
  geom_line(aes(x = year, y = average*10000, group = species_code, color = species_code), size = 2, alpha = 0.5)+
  geom_errorbar(aes(y = average*10000, x = year, ymin = low_cl*10000, ymax = up_cl*10000, colour = species_code), size = 0.7)+
  geom_point(aes(x = year, y = average*10000, group = species_code, color = species_code), fill = "black", size = 3,alpha = 0.8)+
  
  geom_text(data = tag , aes(x = 1999, y = 900, label = tag), size = 8, fontface = "bold")+ # add labels
  
  theme_bw()+
  labs(y = "Individuals per hectare", x = element_blank(), fill = "Species", color = "Species")+
  facet_wrap(~phase_built_code, ncol = 1, labeller = as_labeller(site_names))+ 
  theme(axis.text.x = element_text( size = 20), axis.text.y = element_text(size = 20), strip.text.x = element_text(size =20),
        axis.title.x = element_text(size = 20),
        legend.title = element_text(size=20),legend.text = element_text(size=14),
        axis.title.y = element_text(size = 25),
        legend.spacing.y = unit(1, "cm"))+
  guides(color = guide_legend(byrow = TRUE))+
  scale_color_brewer(palette = "Dark2",labels = c("Kelp Bass", "Barred Sand Bass", "California Sheephead"))
  
```
